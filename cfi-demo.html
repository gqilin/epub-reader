<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUBReader CFIç³»ç»Ÿæ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .demo-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .demo-section:last-child {
            border-bottom: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #545b62;
        }

        .content-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            line-height: 1.8;
            font-size: 16px;
        }

        .info-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .cfi-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }

        .selection-info {
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .position-info {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .highlight {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .note {
            background: #ff9800;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 12px;
        }

        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“ EPUBReader CFIç³»ç»Ÿæ¼”ç¤º</h1>
            <p>æµ‹è¯•ä½ç½®è¿½è¸ªã€æ–‡æœ¬é€‰æ‹©å’Œæ³¨é‡ŠåŠŸèƒ½</p>
        </header>

        <div class="demo-section">
            <h2>ğŸ“– æµ‹è¯•å†…å®¹</h2>
            <div class="content-container" id="contentContainer">
                <h3 id="chapter1">ç¬¬ä¸€ç« ï¼šCFIç³»ç»Ÿä»‹ç»</h3>
                <p>CFIï¼ˆCanonical Fragment Identifierï¼‰æ˜¯ä¸€ç§ç”¨äºæ ‡è¯†EPUBæ–‡æ¡£ä¸­ä»»æ„ä½ç½®çš„æ ‡å‡†åŒ–æ–¹å¼ã€‚å®ƒèƒ½å¤Ÿç²¾ç¡®å®šä½åˆ°æ–‡æ¡£ä¸­çš„ç‰¹å®šå…ƒç´ ã€æ–‡æœ¬èŠ‚ç‚¹ç”šè‡³å­—ç¬¦ä½ç½®ã€‚</p>
                
                <h4>1.1 CFIçš„åŸºæœ¬ç»“æ„</h4>
                <p>CFIç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆï¼ŒåŒ…æ‹¬ç« èŠ‚æ ‡è¯†ç¬¦ã€è·¯å¾„è¡¨è¾¾å¼å’Œå¯é€‰çš„æ–‡æœ¬åç§»é‡ã€‚é€šè¿‡CFIï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é‡æ–°åŠ è½½æ–‡æ¡£åå‡†ç¡®æ¢å¤åˆ°ä¹‹å‰çš„ä½ç½®ã€‚</p>
                
                <p>ä¾‹å¦‚ï¼š<code>epube:/chapter1/4/2!/4:10</code> è¡¨ç¤ºchapter1ç« èŠ‚ä¸­ç¬¬4ä¸ªå…ƒç´ çš„ç¬¬2ä¸ªå­å…ƒç´ çš„ç¬¬4ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„ç¬¬10ä¸ªå­—ç¬¦ä½ç½®ã€‚</p>
                
                <h4>1.2 åº”ç”¨åœºæ™¯</h4>
                <p>CFIåœ¨ç”µå­ä¹¦é˜…è¯»å™¨ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨åœºæ™¯ï¼š</p>
                <ul>
                    <li>ä¿å­˜é˜…è¯»ä½ç½®</li>
                    <li>åˆ›å»ºä¹¦ç­¾å’Œç¬”è®°</li>
                    <li>å®ç°æ–‡æœ¬é«˜äº®å’Œåˆ’çº¿</li>
                    <li>æ”¯æŒæœç´¢ç»“æœå®šä½</li>
                </ul>
                
                <h4>1.3 ä¼˜åŠ¿ç‰¹æ€§</h4>
                <p>ç›¸æ¯”ä¼ ç»Ÿçš„é¡µç æˆ–ç™¾åˆ†æ¯”å®šä½ï¼ŒCFIå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
                <p>é¦–å…ˆï¼Œå®ƒæä¾›äº†åƒç´ çº§çš„ç²¾ç¡®å®šä½èƒ½åŠ›ã€‚å…¶æ¬¡ï¼ŒCFIä¸æ–‡æ¡£å†…å®¹ç»‘å®šï¼Œå³ä½¿åœ¨ä¸åŒè®¾å¤‡æˆ–ä¸åŒå­—ä½“å¤§å°ä¸‹ä¹Ÿèƒ½å‡†ç¡®å®šä½ã€‚æ­¤å¤–ï¼ŒCFIæ”¯æŒè·¨å¹³å°å’Œè·¨åº”ç”¨çš„æ ‡å‡†åŒ–ã€‚</p>
                
                <p>è¿™ä¸ªæ¼”ç¤ºé¡µé¢å±•ç¤ºäº†CFIç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬å®æ—¶ä½ç½®è¿½è¸ªã€æ–‡æœ¬é€‰æ‹©ã€CFIç”Ÿæˆå’Œè§£æç­‰ã€‚ä½ å¯ä»¥å°è¯•é€‰æ‹©æ–‡æœ¬ã€æ»šåŠ¨é¡µé¢ï¼Œç„¶åæŸ¥çœ‹å¯¹åº”çš„CFIä¿¡æ¯ã€‚</p>
            </div>
        </div>

        <div class="demo-section">
            <h2>ğŸ¯ CFIåŠŸèƒ½æ¼”ç¤º</h2>
            <div class="controls">
                <button class="btn" onclick="showCurrentCFI()">è·å–å½“å‰CFI</button>
                <button class="btn" onclick="showCurrentPosition()">æ˜¾ç¤ºä½ç½®ä¿¡æ¯</button>
                <button class="btn secondary" onclick="restorePosition()">æ¢å¤ä½ç½®</button>
                <button class="btn" onclick="highlightSelection()">é«˜äº®é€‰æ‹©</button>
                <button class="btn" onclick="addNote()">æ·»åŠ ç¬”è®°</button>
                <button class="btn secondary" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰</button>
            </div>
            
            <div id="cfiDisplay" class="cfi-display" style="display: none;">
                <strong>å½“å‰CFI:</strong> <span id="currentCFI"></span>
            </div>
            
            <div id="selectionInfo" class="selection-info" style="display: none;">
                <strong>é€‰ä¸­æ–‡æœ¬:</strong> <span id="selectedText"></span><br>
                <strong>å­—æ•°:</strong> <span id="wordCount"></span><br>
                <strong>å­—ç¬¦æ•°:</strong> <span id="charCount"></span>
            </div>
            
            <div id="positionInfo" class="position-info" style="display: none;">
                <strong>ç« èŠ‚è¿›åº¦:</strong> <span id="chapterProgress"></span><br>
                <strong>æ»šåŠ¨ä½ç½®:</strong> <span id="scrollPosition"></span>
            </div>
        </div>

        <div class="demo-section">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <div class="controls">
                <button class="btn secondary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            </div>
            <div id="logContainer" class="log-container">
                ç­‰å¾…æ“ä½œ...
            </div>
        </div>
    </div>

    <!-- å¼•å…¥åº“ (å‡è®¾å·²ç»æ„å»ºäº†åŒ…å«CFIç³»ç»Ÿçš„ç‰ˆæœ¬) -->
    <script src="./dist/epubreader.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let cfiManager = null;
        let savedPosition = null;
        let highlights = [];
        let notes = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCFISystem();
            logMessage('ğŸš€ CFIç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        // åˆå§‹åŒ–CFIç³»ç»Ÿ
        function initCFISystem() {
            const container = document.getElementById('contentContainer');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰CFIç®¡ç†å™¨
                if (typeof EPUBReader.CFIManager !== 'undefined') {
                    cfiManager = new EPUBReader.CFIManager(container, 'chapter1');
                    cfiManager.initialize();
                    
                    // ç›‘å¬ä½ç½®å˜åŒ–
                    cfiManager.onPositionChange(function(event) {
                        logMessage(`ğŸ“ ä½ç½®å˜åŒ–: ${event.changeType}`);
                        updatePositionDisplay(event.current);
                    });
                    
                    // ç›‘å¬æ–‡æœ¬é€‰æ‹©
                    document.addEventListener('mouseup', handleTextSelection);
                    
                    logMessage('âœ… CFIç®¡ç†å™¨åˆ›å»ºæˆåŠŸ');
                } else {
                    logMessage('âŒ CFIç®¡ç†å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¼”ç¤º');
                    initMockCFISystem();
                }
            } catch (error) {
                logMessage(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                initMockCFISystem();
            }
        }

        // æ¨¡æ‹ŸCFIç³»ç»Ÿï¼ˆå½“å®é™…CFIç³»ç»Ÿä¸å¯ç”¨æ—¶ï¼‰
        function initMockCFISystem() {
            const container = document.getElementById('contentContainer');
            
            // ç®€å•çš„ä½ç½®è¿½è¸ª
            let lastScrollTop = 0;
            
            container.addEventListener('scroll', function() {
                const scrollTop = container.scrollTop;
                if (Math.abs(scrollTop - lastScrollTop) > 50) {
                    lastScrollTop = scrollTop;
                    updateMockPosition(scrollTop);
                }
            });

            document.addEventListener('mouseup', handleTextSelection);
            
            logMessage('ğŸ”„ å¯ç”¨æ¨¡æ‹ŸCFIç³»ç»Ÿ');
        }

        // æ›´æ–°æ¨¡æ‹Ÿä½ç½®
        function updateMockPosition(scrollTop) {
            const container = document.getElementById('contentContainer');
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            const progress = (scrollTop / (scrollHeight - clientHeight) * 100).toFixed(1);
            
            document.getElementById('positionInfo').style.display = 'block';
            document.getElementById('chapterProgress').textContent = `${progress}%`;
            document.getElementById('scrollPosition').textContent = `${scrollTop}px`;
            
            logMessage(`ğŸ“ ä½ç½®æ›´æ–°: ${progress}% (${scrollTop}px)`);
        }

        // å¤„ç†æ–‡æœ¬é€‰æ‹©
        function handleTextSelection() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0) {
                document.getElementById('selectionInfo').style.display = 'block';
                document.getElementById('selectedText').textContent = selectedText;
                document.getElementById('wordCount').textContent = selectedText.split(/\s+/).length;
                document.getElementById('charCount').textContent = selectedText.length;
                
                logMessage(`ğŸ“ é€‰æ‹©æ–‡æœ¬: "${selectedText.substring(0, 30)}..."`);
            } else {
                document.getElementById('selectionInfo').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå½“å‰CFI
        function showCurrentCFI() {
            if (cfiManager) {
                try {
                    const cfi = cfiManager.getCurrentCFI();
                    if (cfi) {
                        const cfiString = cfiManager.toString(cfi);
                        document.getElementById('cfiDisplay').style.display = 'block';
                        document.getElementById('currentCFI').textContent = cfiString;
                        
                        logMessage(`ğŸ” å½“å‰CFI: ${cfiString}`);
                        logMessage(`ğŸ“‹ ç« èŠ‚ID: ${cfi.chapterId}`);
                        logMessage(`ğŸ›¤ï¸ è·¯å¾„é•¿åº¦: ${cfi.path.length}`);
                    } else {
                        logMessage('âš ï¸ æ— æ³•è·å–å½“å‰CFI');
                    }
                } catch (error) {
                    logMessage(`âŒ è·å–CFIå¤±è´¥: ${error.message}`);
                }
            } else {
                // æ¨¡æ‹ŸCFI
                const mockCFI = `epube:/chapter1/4/2!/4:${Math.floor(Math.random() * 100)}`;
                document.getElementById('cfiDisplay').style.display = 'block';
                document.getElementById('currentCFI').textContent = mockCFI;
                logMessage(`ğŸ” æ¨¡æ‹ŸCFI: ${mockCFI}`);
            }
        }

        // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
        function showCurrentPosition() {
            if (cfiManager) {
                try {
                    const position = cfiManager.getCurrentPosition();
                    if (position) {
                        updatePositionDisplay(position);
                    }
                } catch (error) {
                    logMessage(`âŒ è·å–ä½ç½®å¤±è´¥: ${error.message}`);
                }
            } else {
                const container = document.getElementById('contentContainer');
                updateMockPosition(container.scrollTop);
            }
        }

        // æ›´æ–°ä½ç½®æ˜¾ç¤º
        function updatePositionDisplay(position) {
            document.getElementById('positionInfo').style.display = 'block';
            
            if (typeof position.bookProgress === 'number') {
                document.getElementById('chapterProgress').textContent = 
                    `${(position.bookProgress * 100).toFixed(1)}%`;
            }
            
            if (typeof position.viewportOffset === 'number') {
                document.getElementById('scrollPosition').textContent = `${position.viewportOffset}px`;
            }
        }

        // æ¢å¤ä½ç½®
        function restorePosition() {
            if (savedPosition) {
                if (cfiManager) {
                    try {
                        const success = cfiManager.navigateToCFI(savedPosition);
                        if (success) {
                            logMessage(`âœ… ä½ç½®æ¢å¤æˆåŠŸ`);
                        } else {
                            logMessage(`âŒ ä½ç½®æ¢å¤å¤±è´¥`);
                        }
                    } catch (error) {
                        logMessage(`âŒ æ¢å¤å¤±è´¥: ${error.message}`);
                    }
                } else {
                    const container = document.getElementById('contentContainer');
                    container.scrollTop = savedPosition.scrollPosition || 0;
                    logMessage(`ğŸ”„ æ¨¡æ‹Ÿä½ç½®æ¢å¤`);
                }
            } else {
                logMessage(`âš ï¸ æ²¡æœ‰ä¿å­˜çš„ä½ç½®`);
            }
        }

        // é«˜äº®é€‰æ‹©
        function highlightSelection() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0) {
                try {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    span.textContent = selectedText;
                    
                    try {
                        range.deleteContents();
                        range.insertNode(span);
                        
                        // æ¸…é™¤é€‰æ‹©
                        selection.removeAllRanges();
                        
                        highlights.push({
                            text: selectedText,
                            element: span,
                            timestamp: Date.now()
                        });
                        
                        logMessage(`ğŸ¨ é«˜äº®æ·»åŠ : "${selectedText.substring(0, 20)}..."`);
                        logMessage(`ğŸ“Š æ€»é«˜äº®æ•°: ${highlights.length}`);
                    } catch (error) {
                        logMessage(`âŒ é«˜äº®å¤±è´¥: ${error.message}`);
                    }
                } catch (error) {
                    logMessage(`âŒ é€‰æ‹©èŒƒå›´è·å–å¤±è´¥: ${error.message}`);
                }
            } else {
                logMessage(`âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡æœ¬`);
            }
        }

        // æ·»åŠ ç¬”è®°
        function addNote() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0) {
                const noteText = prompt('è¯·è¾“å…¥ç¬”è®°å†…å®¹:');
                
                if (noteText && noteText.trim()) {
                    const note = {
                        text: selectedText,
                        note: noteText.trim(),
                        timestamp: Date.now()
                    };
                    
                    notes.push(note);
                    
                    // åˆ›å»ºç¬”è®°æ ‡è®°
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.className = 'note';
                    span.textContent = 'ğŸ“';
                    span.title = noteText;
                    
                    try {
                        range.deleteContents();
                        range.insertNode(span);
                        selection.removeAllRanges();
                        
                        logMessage(`ğŸ“ ç¬”è®°æ·»åŠ : "${noteText}"`);
                        logMessage(`ğŸ“Š æ€»ç¬”è®°æ•°: ${notes.length}`);
                    } catch (error) {
                        logMessage(`âŒ ç¬”è®°æ·»åŠ å¤±è´¥: ${error.message}`);
                    }
                }
            } else {
                logMessage(`âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡æœ¬`);
            }
        }

        // æ¸…é™¤æ‰€æœ‰
        function clearAll() {
            // æ¸…é™¤é«˜äº®
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(el => {
                const parent = el.parentNode;
                parent.replaceChild(document.createTextNode(el.textContent), el);
            });
            
            // æ¸…é™¤ç¬”è®°
            const noteElements = document.querySelectorAll('.note');
            noteElements.forEach(el => {
                el.remove();
            });
            
            // é‡ç½®æ•°ç»„
            highlights = [];
            notes = [];
            
            // éšè—ä¿¡æ¯é¢æ¿
            document.getElementById('cfiDisplay').style.display = 'none';
            document.getElementById('selectionInfo').style.display = 'none';
            
            // æ¸…é™¤é€‰æ‹©
            window.getSelection().removeAllRanges();
            
            logMessage(`ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œç¬”è®°`);
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('logContainer').textContent = 'æ—¥å¿—å·²æ¸…é™¤...';
        }

        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯
        function logMessage(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—é•¿åº¦
            const lines = logContainer.textContent.split('\n');
            if (lines.length > 50) {
                logContainer.textContent = lines.slice(-50).join('\n');
            }
        }

        // ä¿å­˜å½“å‰ä½ç½®
        window.addEventListener('beforeunload', function() {
            if (cfiManager) {
                const position = cfiManager.getCurrentPosition();
                if (position) {
                    savedPosition = position;
                    logMessage(`ğŸ’¾ ä½ç½®å·²ä¿å­˜`);
                }
            }
        });
    </script>
</body>
</html>