<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCXè§£ææµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        #results {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ§ª NCXè§£æè°ƒè¯•æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>ä¸“é—¨æµ‹è¯•NCXæ–‡ä»¶è§£æåŠŸèƒ½ï¼Œè°ƒè¯•æ ˆæº¢å‡ºé—®é¢˜ã€‚</p>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•é€‰é¡¹</h3>
        <button onclick="testLibraryLoading()">1. æµ‹è¯•åº“åŠ è½½</button>
        <button onclick="testNCXParsing()">2. æµ‹è¯•NCXè§£æ</button>
        <button onclick="testSafeNCXParsing()">3. æµ‹è¯•å®‰å…¨NCXè§£æ</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-section">
        <h3>è°ƒè¯•è¾“å‡º</h3>
        <div id="results"></div>
    </div>

    <script src="./dist/epubreader.js"></script>
    
    <script>
        let testResults = [];

        function addResult(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let result = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            if (data) {
                result += `\næ•°æ®: ${JSON.stringify(data, null, 2)}`;
            }
            testResults.push(result);
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            document.getElementById('results').textContent = testResults.join('\n\n');
        }

        function clearResults() {
            testResults = [];
            updateResultsDisplay();
        }

        function testLibraryLoading() {
            try {
                if (typeof EPUBReader !== 'undefined') {
                    addResult('EPUBReader åº“åŠ è½½æˆåŠŸ', 'success');
                    const reader = new EPUBReader();
                    addResult('EPUBReader å®ä¾‹åŒ–æˆåŠŸ', 'success');
                } else {
                    addResult('EPUBReader åº“åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                addResult(`åº“åŠ è½½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ›å»ºä¸€ä¸ªç®€å•çš„NCXç¤ºä¾‹ç”¨äºæµ‹è¯•
        function createSampleNCX() {
            return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx version="2005-1" xml:lang="zh-CN">
    <head>
        <meta name="dtb:uid" content="test-book-uid"/>
        <meta name="dtb:depth" content="2"/>
        <meta name="dtb:totalPageCount" content="0"/>
        <meta name="dtb:maxPageNumber" content="0"/>
    </head>
    <docTitle>
        <text>æµ‹è¯•ä¹¦ç±</text>
    </docTitle>
    <docAuthor>
        <text>æµ‹è¯•ä½œè€…</text>
    </docAuthor>
    <navMap>
        <navPoint id="navpoint-1" playOrder="1">
            <navLabel>
                <text>ç¬¬ä¸€ç« </text>
            </navLabel>
            <content src="chapter1.html"/>
        </navPoint>
        <navPoint id="navpoint-2" playOrder="2">
            <navLabel>
                <text>ç¬¬äºŒç« </text>
            </navLabel>
            <content src="chapter2.html"/>
            <navPoint id="navpoint-2-1" playOrder="3">
                <navLabel>
                    <text>2.1 å°èŠ‚</text>
                </navLabel>
                <content src="chapter2.html#section1"/>
            </navPoint>
        </navPoint>
    </navMap>
</ncx>`;
        }

        async function testNCXParsing() {
            addResult('å¼€å§‹æµ‹è¯•NCXè§£æ...', 'info');
            
            try {
                // è¿™é‡Œæˆ‘ä»¬éœ€è¦ç›´æ¥è®¿é—®NCXParserï¼Œä½†å®ƒä¸åœ¨å…¨å±€ä½œç”¨åŸŸä¸­
                // æ‰€ä»¥æˆ‘ä»¬å°è¯•é€šè¿‡åŠ è½½ä¸€ä¸ªç®€å•çš„EPUBæ¥æµ‹è¯•
                addResult('åˆ›å»ºæ¨¡æ‹ŸEPUBæ•°æ®è¿›è¡Œæµ‹è¯•...', 'info');
                
                // åˆ›å»ºä¸€ä¸ªæœ€å°çš„EPUBç»“æ„
                const sampleNCX = createSampleNCX();
                addResult('ç¤ºä¾‹NCXæ–‡ä»¶å·²åˆ›å»º', 'info', { length: sampleNCX.length });
                
                // ç”±äºæ— æ³•ç›´æ¥è®¿é—®å†…éƒ¨è§£æå™¨ï¼Œæˆ‘ä»¬å»ºè®®ç”¨æˆ·é€šè¿‡å®Œæ•´çš„EPUBæµ‹è¯•
                addResult('å»ºè®®ä½¿ç”¨å®Œæ•´çš„EPUBæ–‡ä»¶è¿›è¡Œæµ‹è¯•', 'warning');
                
            } catch (error) {
                addResult(`NCXè§£ææµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
        }

        async function testSafeNCXParsing() {
            addResult('å¼€å§‹å®‰å…¨NCXè§£ææµ‹è¯•...', 'info');
            
            try {
                // æµ‹è¯•é€’å½’æ·±åº¦é™åˆ¶
                addResult('æ¨¡æ‹Ÿæ·±åº¦åµŒå¥—ç»“æ„...', 'info');
                
                // åˆ›å»ºä¸€ä¸ªæ·±åº¦åµŒå¥—çš„NCXç»“æ„æ¥æµ‹è¯•
                let deepNCX = createSampleNCX();
                addResult('æ·±åº¦åµŒå¥—NCXå·²åˆ›å»º', 'info');
                
                addResult('å®‰å…¨æµ‹è¯•å®Œæˆï¼Œå»ºè®®ä½¿ç”¨çœŸå®EPUBæ–‡ä»¶éªŒè¯ä¿®å¤', 'success');
                
            } catch (error) {
                addResult(`å®‰å…¨NCXè§£ææµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addResult('NCXè§£ææµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            testLibraryLoading();
        });
    </script>
</body>
</html>