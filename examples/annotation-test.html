<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUBæ ‡è®°åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .control-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .control-btn:hover {
            background: #0056b3;
        }
        
        .control-btn.active {
            background: #28a745;
        }
        
        #epub-container {
            min-height: 400px;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            position: relative;
            line-height: 1.8;
            font-size: 16px;
        }
        
        .annotation-toolbar {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            gap: 4px;
            z-index: 10000;
        }
        
        .tool-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .tool-btn:hover {
            background: #f0f0f0;
        }
        
        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        
        .annotation-list {
            margin-top: 15px;
        }
        
        .annotation-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .annotation-type {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š EPUBæ ‡è®°åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="controls">
            <button id="toggle-annotations" class="control-btn">ğŸ“ å¯ç”¨æ ‡è®°åŠŸèƒ½</button>
            <button id="show-annotations" class="control-btn">ğŸ“‹ æ˜¾ç¤ºæ ‡è®°åˆ—è¡¨</button>
            <button id="export-annotations" class="control-btn">ğŸ’¾ å¯¼å‡ºæ ‡è®°</button>
            <button id="import-annotations" class="control-btn">ğŸ“‚ å¯¼å…¥æ ‡è®°</button>
            <button id="clear-annotations" class="control-btn">ğŸ—‘ï¸ æ¸…ç©ºæ ‡è®°</button>
        </div>
        
        <div id="epub-container">
            <h2>ç¬¬ä¸€ç« ï¼šæµ‹è¯•ç« èŠ‚</h2>
            <p>è¿™æ˜¯ä¸€æ®µç”¨äºæµ‹è¯•æ ‡è®°åŠŸèƒ½çš„ç¤ºä¾‹æ–‡æœ¬ã€‚ä½ å¯ä»¥é€‰æ‹©è¿™æ®µæ–‡å­—ä¸­çš„ä»»æ„éƒ¨åˆ†æ¥åˆ›å»ºä¸åŒç±»å‹çš„æ ‡è®°ã€‚</p>
            
            <p><strong>é«˜äº®æµ‹è¯•ï¼š</strong>é€‰æ‹©è¿™æ®µæ–‡å­—ç„¶åç‚¹å‡»é«˜äº®æŒ‰é’®ï¼Œå®ƒä¼šä»¥é»„è‰²èƒŒæ™¯é«˜äº®æ˜¾ç¤ºã€‚é«˜äº®åŠŸèƒ½éå¸¸é€‚åˆæ ‡è®°é‡è¦æ®µè½æˆ–å…³é”®ä¿¡æ¯ã€‚</p>
            
            <p><strong>ä¸‹åˆ’çº¿æµ‹è¯•ï¼š</strong>é€‰æ‹©è¿™æ®µæ–‡å­—ç‚¹å‡»ä¸‹åˆ’çº¿æŒ‰é’®ï¼Œä¼šåœ¨æ–‡å­—ä¸‹æ–¹æ·»åŠ è“è‰²ä¸‹åˆ’çº¿ã€‚ä¸‹åˆ’çº¿å¸¸ç”¨äºæ ‡è®°éœ€è¦ç‰¹åˆ«æ³¨æ„çš„å†…å®¹ã€‚</p>
            
            <p><strong>ç¬”è®°æµ‹è¯•ï¼š</strong>é€‰æ‹©è¿™æ®µæ–‡å­—ç‚¹å‡»ç¬”è®°æŒ‰é’®ï¼Œå¯ä»¥ä¸ºé€‰ä¸­çš„æ–‡å­—æ·»åŠ ä¸ªäººç¬”è®°ã€‚ç¬”è®°åŠŸèƒ½å¸®åŠ©ä½ è®°å½•æƒ³æ³•å’Œç†è§£ã€‚</p>
            
            <p><strong>ä¹¦ç­¾æµ‹è¯•ï¼š</strong>é€‰æ‹©è¿™æ®µæ–‡å­—ç‚¹å‡»ä¹¦ç­¾æŒ‰é’®ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ©™è‰²ä¹¦ç­¾æ ‡è®°ã€‚ä¹¦ç­¾åŠŸèƒ½ç”¨äºå¿«é€Ÿå®šä½é‡è¦ä½ç½®ã€‚</p>
            
            <h3>åŠŸèƒ½è¯´æ˜</h3>
            <ul>
                <li>é€‰æ‹©ä»»æ„æ–‡å­—åä¼šè‡ªåŠ¨æ˜¾ç¤ºæ ‡è®°å·¥å…·æ </li>
                <li>å·¥å…·æ ä¼šåœ¨3ç§’åè‡ªåŠ¨éšè—</li>
                <li>æ‰€æœ‰æ ‡è®°éƒ½ä¼šä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨</li>
                <li>æ”¯æŒå¯¼å‡ºå’Œå¯¼å…¥æ ‡è®°æ•°æ®</li>
                <li>æ ‡è®°åŸºäºCFIæ ‡å‡†ç²¾ç¡®å®šä½</li>
            </ul>
        </div>
        
        <div id="annotation-toolbar" class="annotation-toolbar">
            <button class="tool-btn" data-action="highlight">ğŸŸ¨ é«˜äº®</button>
            <button class="tool-btn" data-action="underline">UÌ² ä¸‹åˆ’çº¿</button>
            <button class="tool-btn" data-action="note">ğŸ“ ç¬”è®°</button>
            <button class="tool-btn" data-action="bookmark">ğŸ”– ä¹¦ç­¾</button>
        </div>
        
        <div class="info-panel">
            <h3>â„¹ï¸ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li>ç‚¹å‡»"ğŸ“ å¯ç”¨æ ‡è®°åŠŸèƒ½"æŒ‰é’®æ¿€æ´»æ ‡è®°ç³»ç»Ÿ</li>
                <li>åœ¨ä¸Šæ–¹æ–‡æœ¬åŒºåŸŸé€‰æ‹©ä»»æ„æ–‡å­—</li>
                <li>ä»å¼¹å‡ºçš„å·¥å…·æ é€‰æ‹©æ ‡è®°ç±»å‹</li>
                <li>ä½¿ç”¨"ğŸ“‹ æ˜¾ç¤ºæ ‡è®°åˆ—è¡¨"æŸ¥çœ‹æ‰€æœ‰æ ‡è®°</li>
                <li>ä½¿ç”¨"ğŸ’¾ å¯¼å‡ºæ ‡è®°"ä¿å­˜æ ‡è®°æ•°æ®</li>
            </ol>
            
            <div id="annotation-stats" class="annotation-stats">
                <strong>ç»Ÿè®¡ä¿¡æ¯ï¼š</strong>
                <span id="stats">æš‚æ— æ ‡è®°æ•°æ®</span>
            </div>
        </div>
        
        <div id="annotation-list" class="annotation-list" style="display: none;">
            <h3>ğŸ“‹ æ ‡è®°åˆ—è¡¨</h3>
            <div id="annotation-items"></div>
        </div>
    </div>

    <script type="module">
        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä½¿ç”¨å®é™…çš„æ„å»ºç‰ˆæœ¬
        // import { EpubReader } from '../dist/index.js';
        
        // æ¨¡æ‹Ÿæ ‡è®°ç®¡ç†å™¨ï¼ˆå®é™…ä½¿ç”¨æ—¶ä¼šä½¿ç”¨çœŸå®çš„EpubReaderï¼‰
        class MockAnnotationManager {
            constructor() {
                this.annotations = JSON.parse(localStorage.getItem('test-annotations') || '[]');
            }
            
            async createAnnotation(type, text, options = {}) {
                const annotation = {
                    id: 'ann_' + Date.now(),
                    type,
                    text,
                    color: options.color || this.getDefaultColor(type),
                    note: options.note,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    chapterId: 'test-chapter'
                };
                
                this.annotations.push(annotation);
                this.save();
                return annotation;
            }
            
            async removeAnnotation(id) {
                const index = this.annotations.findIndex(ann => ann.id === id);
                if (index !== -1) {
                    this.annotations.splice(index, 1);
                    this.save();
                }
            }
            
            getAnnotations(chapterId) {
                if (!chapterId) return this.annotations;
                return this.annotations.filter(ann => ann.chapterId === chapterId);
            }
            
            exportAnnotations() {
                return JSON.stringify(this.annotations, null, 2);
            }
            
            async importAnnotations(data, merge = false) {
                const imported = JSON.parse(data);
                this.annotations = merge ? [...this.annotations, ...imported] : imported;
                this.save();
            }
            
            save() {
                localStorage.setItem('test-annotations', JSON.stringify(this.annotations));
            }
            
            getDefaultColor(type) {
                const colors = {
                    highlight: '#ffeb3b',
                    underline: '#2196f3',
                    note: '#4caf50',
                    bookmark: '#ff9800'
                };
                return colors[type] || '#ffeb3b';
            }
            
            getStats() {
                const stats = {
                    total: this.annotations.length,
                    highlight: this.annotations.filter(ann => ann.type === 'highlight').length,
                    underline: this.annotations.filter(ann => ann.type === 'underline').length,
                    note: this.annotations.filter(ann => ann.type === 'note').length,
                    bookmark: this.annotations.filter(ann => ann.type === 'bookmark').length
                };
                return stats;
            }
        }
        
        // åˆå§‹åŒ–
        let annotationsEnabled = false;
        let annotationManager = new MockAnnotationManager();
        
        const container = document.getElementById('epub-container');
        const toolbar = document.getElementById('annotation-toolbar');
        const toggleBtn = document.getElementById('toggle-annotations');
        const showBtn = document.getElementById('show-annotations');
        const exportBtn = document.getElementById('export-annotations');
        const importBtn = document.getElementById('import-annotations');
        const clearBtn = document.getElementById('clear-annotations');
        const annotationList = document.getElementById('annotation-list');
        const annotationItems = document.getElementById('annotation-items');
        const stats = document.getElementById('stats');
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const data = annotationManager.getStats();
            stats.innerHTML = `
                æ€»è®¡: ${data.total} ä¸ªæ ‡è®° | 
                ğŸŸ¨ é«˜äº®: ${data.highlight} | 
                UÌ² ä¸‹åˆ’çº¿: ${data.underline} | 
                ğŸ“ ç¬”è®°: ${data.note} | 
                ğŸ”– ä¹¦ç­¾: ${data.bookmark}
            `;
        }
        
        // æ›´æ–°æ ‡è®°åˆ—è¡¨æ˜¾ç¤º
        function updateAnnotationList() {
            const annotations = annotationManager.getAnnotations();
            
            if (annotations.length === 0) {
                annotationItems.innerHTML = '<p style="color: #666; font-style: italic;">æš‚æ— æ ‡è®°</p>';
            } else {
                annotationItems.innerHTML = annotations.map(ann => `
                    <div class="annotation-item">
                        <div class="annotation-type">${getAnnotationIcon(ann.type)} ${getAnnotationTypeName(ann.type)}</div>
                        <div style="margin: 5px 0;">${ann.text}</div>
                        ${ann.note ? `<div style="background: #e8f5e8; padding: 5px; border-radius: 3px; margin: 5px 0;">ğŸ“ ${ann.note}</div>` : ''}
                        <button onclick="removeAnnotation('${ann.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
                    </div>
                `).join('');
            }
            
            updateStats();
        }
        
        function getAnnotationIcon(type) {
            const icons = {
                highlight: 'ğŸŸ¨',
                underline: 'UÌ²',
                note: 'ğŸ“',
                bookmark: 'ğŸ”–'
            };
            return icons[type] || 'ğŸ“Œ';
        }
        
        function getAnnotationTypeName(type) {
            const names = {
                highlight: 'é«˜äº®',
                underline: 'ä¸‹åˆ’çº¿',
                note: 'ç¬”è®°',
                bookmark: 'ä¹¦ç­¾'
            };
            return names[type] || 'æœªçŸ¥';
        }
        
        window.removeAnnotation = async function(id) {
            await annotationManager.removeAnnotation(id);
            updateAnnotationList();
        };
        
        // åˆ‡æ¢æ ‡è®°åŠŸèƒ½
        toggleBtn.addEventListener('click', () => {
            annotationsEnabled = !annotationsEnabled;
            toggleBtn.textContent = annotationsEnabled ? 'ğŸ“ ç¦ç”¨æ ‡è®°åŠŸèƒ½' : 'ğŸ“ å¯ç”¨æ ‡è®°åŠŸèƒ½';
            toggleBtn.classList.toggle('active', annotationsEnabled);
            
            if (annotationsEnabled) {
                setupTextSelection();
            }
        });
        
        // è®¾ç½®æ–‡å­—é€‰æ‹©ç›‘å¬
        function setupTextSelection() {
            container.addEventListener('mouseup', handleTextSelection);
            container.addEventListener('touchend', handleTextSelection);
            document.addEventListener('selectionchange', handleSelectionChange);
        }
        
        function handleTextSelection() {
            setTimeout(() => {
                const selection = window.getSelection();
                if (!selection || selection.isCollapsed) {
                    hideToolbar();
                    return;
                }
                
                const selectedText = selection.toString().trim();
                if (selectedText.length < 1) {
                    hideToolbar();
                    return;
                }
                
                showToolbar(selection);
            }, 10);
        }
        
        function handleSelectionChange() {
            const selection = window.getSelection();
            if (!selection || selection.isCollapsed) {
                hideToolbar();
            }
        }
        
        function showToolbar(selection) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            let left = rect.left + window.scrollX;
            let top = rect.bottom + window.scrollY + 5;
            
            // é˜²æ­¢è¶…å‡ºè§†çª—
            if (left + 200 > window.innerWidth) {
                left = window.innerWidth - 210;
            }
            
            if (top + 60 > window.innerHeight + window.scrollY) {
                top = rect.top + window.scrollY - 65;
            }
            
            toolbar.style.left = left + 'px';
            toolbar.style.top = top + 'px';
            toolbar.style.display = 'flex';
            toolbar.style.opacity = '0';
            
            setTimeout(() => {
                toolbar.style.opacity = '1';
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(hideToolbar, 3000);
        }
        
        function hideToolbar() {
            toolbar.style.opacity = '0';
            setTimeout(() => {
                toolbar.style.display = 'none';
            }, 200);
        }
        
        // å·¥å…·æ æŒ‰é’®äº‹ä»¶
        toolbar.addEventListener('click', async (e) => {
            if (e.target.classList.contains('tool-btn')) {
                const action = e.target.getAttribute('data-action');
                const selection = window.getSelection();
                
                if (!selection || selection.isCollapsed) return;
                
                const selectedText = selection.toString().trim();
                if (!selectedText) return;
                
                try {
                    let options = {};
                    
                    if (action === 'note') {
                        const note = prompt('è¯·è¾“å…¥ç¬”è®°å†…å®¹ï¼š');
                        if (!note) return;
                        options = { note };
                    }
                    
                    await annotationManager.createAnnotation(action, selectedText, options);
                    
                    // æ¸…é™¤é€‰æ‹©
                    selection.removeAllRanges();
                    hideToolbar();
                    
                    updateAnnotationList();
                    
                } catch (error) {
                    console.error('åˆ›å»ºæ ‡è®°å¤±è´¥:', error);
                    alert('åˆ›å»ºæ ‡è®°å¤±è´¥: ' + error.message);
                }
            }
        });
        
        // æ˜¾ç¤ºæ ‡è®°åˆ—è¡¨
        showBtn.addEventListener('click', () => {
            const isHidden = annotationList.style.display === 'none';
            annotationList.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                updateAnnotationList();
            }
        });
        
        // å¯¼å‡ºæ ‡è®°
        exportBtn.addEventListener('click', () => {
            try {
                const data = annotationManager.exportAnnotations();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `epub-annotations-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        });
        
        // å¯¼å…¥æ ‡è®°
        importBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const merge = confirm('æ˜¯å¦ä¸ç°æœ‰æ ‡è®°åˆå¹¶ï¼Ÿ(ç‚¹å‡»"ç¡®å®š"åˆå¹¶ï¼Œç‚¹å‡»"å–æ¶ˆ"æ›¿æ¢)');
                    
                    await annotationManager.importAnnotations(text, merge);
                    updateAnnotationList();
                    
                    alert('æ ‡è®°å¯¼å…¥æˆåŠŸï¼');
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            input.click();
        });
        
        // æ¸…ç©ºæ ‡è®°
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ ‡è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                annotationManager = new MockAnnotationManager();
                annotationManager.save(); // ä¿å­˜ç©ºåˆ—è¡¨
                updateAnnotationList();
                alert('æ‰€æœ‰æ ‡è®°å·²æ¸…ç©ºï¼');
            }
        });
        
        // åˆå§‹åŒ–æ˜¾ç¤º
        updateStats();
    </script>
</body>
</html>