<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUBReader åŠŸèƒ½æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .display-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .file-upload {
            margin-bottom: 1.5rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input-label:hover {
            background: #5a6fd8;
        }

        .file-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
            font-size: 0.9rem;
        }

        .button:hover {
            background: #5a6fd8;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.secondary:hover {
            background: #5a6268;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            margin-bottom: 1rem;
        }

        .metadata-label {
            font-weight: bold;
            color: #667eea;
        }

        .toc-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0.5rem;
        }

        .toc-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .toc-item:hover {
            background: #f0f0f0;
        }

        .toc-item.active {
            background: #667eea;
            color: white;
        }

        .toc-level-1 { margin-left: 0; }
        .toc-level-2 { margin-left: 1.5rem; }
        .toc-level-3 { margin-left: 3rem; }
        .toc-level-4 { margin-left: 4.5rem; }

        .chapter-content {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
            background: #fafafa;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .search-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0.5rem;
        }

        .search-result-item {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f9f9f9;
            border-radius: 3px;
        }

        .search-result-chapter {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .search-result-match {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .search-result-context {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }

        .status-bar {
            background: #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-indicator.ready { background: #28a745; }
        .status-indicator.loading { background: #ffc107; }
        .status-indicator.error { background: #dc3545; }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š EPUBReader åŠŸèƒ½æµ‹è¯•</h1>
            <p class="subtitle">æµ‹è¯•EPUBè§£æåº“çš„å„é¡¹åŠŸèƒ½</p>
        </header>

        <div class="main-content">
            <aside class="control-panel">
                <h2 class="section-title">ğŸ“ æ–‡ä»¶åŠ è½½</h2>
                <div class="file-upload">
                    <div class="file-input-wrapper">
                        <input type="file" id="epubFile" class="file-input" accept=".epub">
                        <label for="epubFile" class="file-input-label">
                            é€‰æ‹©EPUBæ–‡ä»¶
                        </label>
                    </div>
                    <div id="fileInfo" class="file-info"></div>
                </div>

                <div id="loadStatus" class="status-bar">
                    <span>
                        <span id="statusIndicator" class="status-indicator"></span>
                        <span id="statusText">æœªåŠ è½½æ–‡ä»¶</span>
                    </span>
                    <span id="loadTime"></span>
                </div>

                <h2 class="section-title" style="margin-top: 2rem;">ğŸ” æœç´¢åŠŸèƒ½</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯...">
                    <button id="searchBtn" class="button" disabled>æœç´¢</button>
                </div>
                <div class="search-options">
                    <label>
                        <input type="checkbox" id="caseSensitive"> åŒºåˆ†å¤§å°å†™
                    </label>
                    <label>
                        <input type="checkbox" id="wholeWord"> å…¨è¯åŒ¹é…
                    </label>
                    <label>
                        <input type="checkbox" id="regex"> æ­£åˆ™è¡¨è¾¾å¼
                    </label>
                </div>
            </aside>

            <main class="display-panel">
                <div class="tabs">
                    <button class="tab active" data-tab="metadata">ğŸ“‹ å…ƒæ•°æ®</button>
                    <button class="tab" data-tab="toc">ğŸ“‘ ç›®å½•</button>
                    <button class="tab" data-tab="content">ğŸ“– å†…å®¹</button>
                    <button class="tab" data-tab="search">ğŸ” æœç´¢ç»“æœ</button>
                </div>

                <div id="metadataTab" class="tab-content active">
                    <h2 class="section-title">ä¹¦ç±å…ƒæ•°æ®</h2>
                    <div id="metadataContent">
                        <p style="color: #666; text-align: center; padding: 2rem;">
                            è¯·å…ˆåŠ è½½EPUBæ–‡ä»¶
                        </p>
                    </div>
                </div>

                <div id="tocTab" class="tab-content">
                    <h2 class="section-title">ç›®å½•ç»“æ„</h2>
                    <div id="tocContent">
                        <p style="color: #666; text-align: center; padding: 2rem;">
                            è¯·å…ˆåŠ è½½EPUBæ–‡ä»¶
                        </p>
                    </div>
                </div>

                <div id="contentTab" class="tab-content">
                    <h2 class="section-title">ç« èŠ‚å†…å®¹</h2>
                    <div id="chapterInfo" style="margin-bottom: 1rem;">
                        <span id="chapterTitle"></span>
                        <span id="chapterStats" style="margin-left: 1rem; color: #666;"></span>
                    </div>
                    <div id="chapterContent" class="chapter-content">
                        <p style="color: #666; text-align: center; padding: 2rem;">
                            è¯·ä»ç›®å½•ä¸­é€‰æ‹©ç« èŠ‚
                        </p>
                    </div>
                </div>

                <div id="searchTab" class="tab-content">
                    <h2 class="section-title">æœç´¢ç»“æœ</h2>
                    <div id="searchResults">
                        <p style="color: #666; text-align: center; padding: 2rem;">
                            è¯·è¾“å…¥æœç´¢å…³é”®è¯
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- å¼•å…¥æ„å»ºåçš„EPUBReaderåº“ -->
    <script src="./dist/epubreader.js"></script>
    
    <!-- æ¨¡æ‹Ÿæ•°æ® (ç”¨äºæ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šè§£æçœŸå®EPUBæ–‡ä»¶) -->
    <script>
        // åœ¨åŠ è½½çœŸå®EPUBæ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬ç”¨æ¨¡æ‹Ÿæ•°æ®æ¥æ¼”ç¤ºåŠŸèƒ½
        let useMockData = false;
        class MockEPUBReader {
            constructor() {
                this.book = null;
                this.isLoaded = false;
            }

            async load(arrayBuffer) {
                // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ¨¡æ‹Ÿæ•°æ®
                this.book = {
                    metadata: {
                        title: 'ç¤ºä¾‹ç”µå­ä¹¦',
                        creator: 'ç¤ºä¾‹ä½œè€…',
                        language: 'zh-CN',
                        publisher: 'ç¤ºä¾‹å‡ºç‰ˆç¤¾',
                        description: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹EPUBç”µå­ä¹¦ï¼Œç”¨äºæµ‹è¯•EPUBReaderåº“çš„åŠŸèƒ½ã€‚',
                        date: '2024-01-01'
                    },
                    chapters: [
                        { id: 'chapter1', title: 'ç¬¬ä¸€ç« ï¼šå¼€å§‹', href: 'chapter1.html', order: 0 },
                        { id: 'chapter2', title: 'ç¬¬äºŒç« ï¼šæ·±å…¥', href: 'chapter2.html', order: 1 },
                        { id: 'chapter3', title: 'ç¬¬ä¸‰ç« ï¼šå®è·µ', href: 'chapter3.html', order: 2 }
                    ],
                    toc: {
                        id: 'root',
                        title: '',
                        href: '',
                        order: 0,
                        level: 0,
                        children: [
                            {
                                id: 'toc1',
                                title: 'ç¬¬ä¸€ç« ï¼šå¼€å§‹',
                                href: 'chapter1.html',
                                order: 0,
                                level: 1,
                                children: []
                            },
                            {
                                id: 'toc2',
                                title: 'ç¬¬äºŒç« ï¼šæ·±å…¥',
                                href: 'chapter2.html',
                                order: 1,
                                level: 1,
                                children: [
                                    {
                                        id: 'toc2-1',
                                        title: '2.1 åŸºç¡€æ¦‚å¿µ',
                                        href: 'chapter2.html#section1',
                                        order: 0,
                                        level: 2,
                                        children: []
                                    },
                                    {
                                        id: 'toc2-2',
                                        title: '2.2 è¿›é˜¶å†…å®¹',
                                        href: 'chapter2.html#section2',
                                        order: 1,
                                        level: 2,
                                        children: []
                                    }
                                ]
                            },
                            {
                                id: 'toc3',
                                title: 'ç¬¬ä¸‰ç« ï¼šå®è·µ',
                                href: 'chapter3.html',
                                order: 2,
                                level: 1,
                                children: []
                            }
                        ]
                    }
                };
                
                this.isLoaded = true;
                return this.book;
            }

            getMetadata() {
                if (!this.isLoaded) throw new Error('EPUB not loaded');
                return this.book.metadata;
            }

            getTableOfContents() {
                if (!this.isLoaded) throw new Error('EPUB not loaded');
                return this.book.toc;
            }

            getChapters() {
                if (!this.isLoaded) throw new Error('EPUB not loaded');
                return this.book.chapters;
            }

            async getChapter(chapterId) {
                if (!this.isLoaded) throw new Error('EPUB not loaded');
                
                const chapter = this.book.chapters.find(ch => ch.id === chapterId);
                if (!chapter) throw new Error('Chapter not found');
                
                // æ¨¡æ‹ŸåŠ è½½ç« èŠ‚å†…å®¹
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const mockContent = `
                    <h1>${chapter.title}</h1>
                    <p>è¿™æ˜¯${chapter.title}çš„ç¤ºä¾‹å†…å®¹ã€‚</p>
                    <p>EPUBReaderåº“å¯ä»¥è§£æEPUBæ ¼å¼çš„ç”µå­ä¹¦ï¼Œæå–å…ƒæ•°æ®ã€ç›®å½•ç»“æ„å’Œç« èŠ‚å†…å®¹ã€‚</p>
                    <p>è¿™ä¸ªæµ‹è¯•é¡µé¢å±•ç¤ºäº†åº“çš„ä¸»è¦åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡ä»¶åŠ è½½ã€å…ƒæ•°æ®æ˜¾ç¤ºã€ç›®å½•å¯¼èˆªå’Œå†…å®¹é˜…è¯»ã€‚</p>
                    <h2>åŠŸèƒ½ç‰¹æ€§</h2>
                    <ul>
                        <li>æ”¯æŒEPUB 2.0å’Œ3.0æ ¼å¼</li>
                        <li>æ¡†æ¶æ— å…³çš„è®¾è®¡</li>
                        <li>æµè§ˆå™¨å’ŒNode.jsç¯å¢ƒå…¼å®¹</li>
                        <li>å…¨æ–‡æœç´¢åŠŸèƒ½</li>
                        <li>æŒ‰éœ€åŠ è½½ç« èŠ‚å†…å®¹</li>
                    </ul>
                    <p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œç« èŠ‚å†…å®¹ä¼šä»EPUBæ–‡ä»¶ä¸­è§£æå‡ºæ¥ï¼ŒåŒ…å«å®Œæ•´çš„HTMLæ ¼å¼ã€‚</p>
                `;
                
                return {
                    ...chapter,
                    content: mockContent,
                    getPlainText: () => mockContent.replace(/<[^>]*>/g, ''),
                    getWordCount: () => mockContent.split(/\s+/).length,
                    size: mockContent.length
                };
            }

            async search(query, options = {}) {
                if (!this.isLoaded) throw new Error('EPUB not loaded');
                
                const results = [];
                
                for (const chapter of this.book.chapters) {
                    const chapterData = await this.getChapter(chapter.id);
                    const text = chapterData.getPlainText();
                    
                    const regex = options.regex 
                        ? new RegExp(query, options.caseSensitive ? 'g' : 'gi')
                        : new RegExp(
                            options.wholeWord ? `\\b${query}\\b` : query,
                            options.caseSensitive ? 'g' : 'gi'
                        );
                    
                    const matches = [];
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        matches.push({
                            text: match[0],
                            index: match.index,
                            context: this.getContext(text, match.index, 50)
                        });
                    }
                    
                    if (matches.length > 0) {
                        results.push({
                            chapter: chapterData,
                            matches: matches
                        });
                    }
                }
                
                return results;
            }

            getContext(text, index, radius) {
                const start = Math.max(0, index - radius);
                const end = Math.min(text.length, index + radius);
                return text.substring(start, end).trim();
            }

            destroy() {
                this.book = null;
                this.isLoaded = false;
            }
        }
    </script>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const AppState = {
            reader: null,
            currentChapter: null,
            isLoading: false,
            loadStartTime: null
        };

        // DOMå…ƒç´ å¼•ç”¨
        const Elements = {
            fileInput: document.getElementById('epubFile'),
            fileInfo: document.getElementById('fileInfo'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            loadTime: document.getElementById('loadTime'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            caseSensitive: document.getElementById('caseSensitive'),
            wholeWord: document.getElementById('wholeWord'),
            regex: document.getElementById('regex'),
            metadataContent: document.getElementById('metadataContent'),
            tocContent: document.getElementById('tocContent'),
            chapterTitle: document.getElementById('chapterTitle'),
            chapterStats: document.getElementById('chapterStats'),
            chapterContent: document.getElementById('chapterContent'),
            searchResults: document.getElementById('searchResults')
        };

        // åˆå§‹åŒ–
        function init() {
            AppState.reader = new EPUBReader();
            setupEventListeners();
            updateStatus('ready', 'å‡†å¤‡å°±ç»ª');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶é€‰æ‹©
            Elements.fileInput.addEventListener('change', handleFileSelect);
            
            // æœç´¢åŠŸèƒ½
            Elements.searchBtn.addEventListener('click', performSearch);
            Elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.epub')) {
                showError('è¯·é€‰æ‹©EPUBæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            Elements.fileInfo.textContent = `æ–‡ä»¶: ${file.name} (${formatFileSize(file.size)})`;
            
            try {
                await loadEPUB(file);
            } catch (error) {
                showError(`åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        // åŠ è½½EPUBæ–‡ä»¶
        async function loadEPUB(file) {
            AppState.isLoading = true;
            AppState.loadStartTime = Date.now();
            updateStatus('loading', 'æ­£åœ¨åŠ è½½...');

            try {
                const arrayBuffer = await file.arrayBuffer();
                await AppState.reader.load(arrayBuffer);
                
                const loadTime = Date.now() - AppState.loadStartTime;
                Elements.loadTime.textContent = `åŠ è½½è€—æ—¶: ${loadTime}ms`;
                
                updateStatus('ready', 'åŠ è½½å®Œæˆ');
                showSuccess('EPUBæ–‡ä»¶åŠ è½½æˆåŠŸï¼');
                
                // æ›´æ–°å„ä¸ªé¢æ¿
                updateMetadataPanel();
                updateTOCPanel();
                enableSearch();
                
            } catch (error) {
                // å¦‚æœçœŸå®è§£æå¤±è´¥ï¼Œå›é€€åˆ°æ¼”ç¤ºæ¨¡å¼
                console.warn('çœŸå®EPUBè§£æå¤±è´¥ï¼Œåˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼:', error.message);
                useMockData = true;
                AppState.reader = new MockEPUBReader();
                await AppState.reader.load(arrayBuffer);
                
                const loadTime = Date.now() - AppState.loadStartTime;
                Elements.loadTime.textContent = `åŠ è½½è€—æ—¶: ${loadTime}ms (æ¼”ç¤ºæ¨¡å¼)`;
                
                updateStatus('ready', 'æ¼”ç¤ºæ¨¡å¼åŠ è½½å®Œæˆ');
                showSuccess('å·²åˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼ï¼ŒæŸ¥çœ‹åŠŸèƒ½æ¼”ç¤ºï¼');
                
                // æ›´æ–°å„ä¸ªé¢æ¿
                updateMetadataPanel();
                updateTOCPanel();
                enableSearch();
            } finally {
                AppState.isLoading = false;
            }
        }

        // æ›´æ–°å…ƒæ•°æ®é¢æ¿
        function updateMetadataPanel() {
            const metadata = AppState.reader.getMetadata();
            
            const metadataHTML = `
                <div class="metadata-grid">
                    <span class="metadata-label">ä¹¦å:</span>
                    <span>${metadata.title || 'æœªçŸ¥'}</span>
                    
                    <span class="metadata-label">ä½œè€…:</span>
                    <span>${metadata.creator || 'æœªçŸ¥'}</span>
                    
                    <span class="metadata-label">è¯­è¨€:</span>
                    <span>${metadata.language || 'æœªçŸ¥'}</span>
                    
                    <span class="metadata-label">å‡ºç‰ˆå•†:</span>
                    <span>${metadata.publisher || 'æœªçŸ¥'}</span>
                    
                    <span class="metadata-label">æ—¥æœŸ:</span>
                    <span>${metadata.date || 'æœªçŸ¥'}</span>
                    
                    <span class="metadata-label">æè¿°:</span>
                    <span>${metadata.description || 'æ— '}</span>
                </div>
            `;
            
            Elements.metadataContent.innerHTML = metadataHTML;
        }

        // æ›´æ–°ç›®å½•é¢æ¿
        function updateTOCPanel() {
            const toc = AppState.reader.getTableOfContents();
            
            if (!toc || !toc.children || toc.children.length === 0) {
                Elements.tocContent.innerHTML = '<p style="color: #666; text-align: center;">æ— ç›®å½•ä¿¡æ¯</p>';
                return;
            }
            
            const tocHTML = `
                <div class="toc-list">
                    ${renderTOCItems(toc.children)}
                </div>
            `;
            
            Elements.tocContent.innerHTML = tocHTML;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.toc-item').forEach(item => {
                item.addEventListener('click', () => loadChapter(item.dataset.href, item.dataset.title));
            });
        }

        // æ¸²æŸ“ç›®å½•é¡¹
        function renderTOCItems(items) {
            return items.map(item => `
                <div class="toc-item toc-level-${item.level}" 
                     data-href="${item.href}" 
                     data-title="${item.title}">
                    ${item.title}
                </div>
                ${item.children && item.children.length > 0 ? renderTOCItems(item.children) : ''}
            `).join('');
        }

        // åŠ è½½ç« èŠ‚
        async function loadChapter(href, title) {
            try {
                updateStatus('loading', 'æ­£åœ¨åŠ è½½ç« èŠ‚...');
                
                // æŸ¥æ‰¾ç« èŠ‚ID
                const chapters = AppState.reader.getChapters();
                const chapter = chapters.find(ch => ch.href === href);
                if (!chapter) {
                    throw new Error('ç« èŠ‚æœªæ‰¾åˆ°');
                }
                
                AppState.currentChapter = await AppState.reader.getChapter(chapter.id);
                
                // æ›´æ–°ç« èŠ‚ä¿¡æ¯
                Elements.chapterTitle.textContent = AppState.currentChapter.title;
                Elements.chapterStats.textContent = 
                    `${AppState.currentChapter.getWordCount()} å­— | ${formatFileSize(AppState.currentChapter.size)}`;
                
                // æ›´æ–°ç« èŠ‚å†…å®¹
                Elements.chapterContent.innerHTML = AppState.currentChapter.content;
                
                // åˆ‡æ¢åˆ°å†…å®¹æ ‡ç­¾é¡µ
                switchTab('content');
                
                // é«˜äº®å½“å‰ç›®å½•é¡¹
                document.querySelectorAll('.toc-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.href === href);
                });
                
                updateStatus('ready', 'ç« èŠ‚åŠ è½½å®Œæˆ');
                
            } catch (error) {
                showError(`åŠ è½½ç« èŠ‚å¤±è´¥: ${error.message}`);
            }
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const query = Elements.searchInput.value.trim();
            if (!query) {
                showError('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            try {
                updateStatus('loading', 'æ­£åœ¨æœç´¢...');
                
                const options = {
                    caseSensitive: Elements.caseSensitive.checked,
                    wholeWord: Elements.wholeWord.checked,
                    regex: Elements.regex.checked
                };
                
                const results = await AppState.reader.search(query, options);
                
                updateSearchResults(results, query);
                switchTab('search');
                
                updateStatus('ready', `æ‰¾åˆ° ${results.length} ä¸ªç»“æœ`);
                
            } catch (error) {
                showError(`æœç´¢å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°æœç´¢ç»“æœ
        function updateSearchResults(results, query) {
            if (results.length === 0) {
                Elements.searchResults.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 2rem;">
                        æœªæ‰¾åˆ°åŒ…å« "${query}" çš„å†…å®¹
                    </p>
                `;
                return;
            }
            
            const resultsHTML = results.map(result => `
                <div class="search-result-item">
                    <div class="search-result-chapter">${result.chapter.title}</div>
                    <div class="search-result-match">æ‰¾åˆ° ${result.matches.length} ä¸ªåŒ¹é…é¡¹:</div>
                    ${result.matches.map((match, index) => `
                        <div class="search-result-context">
                            åŒ¹é… ${index + 1}: ...${match.context}...
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            Elements.searchResults.innerHTML = resultsHTML;
        }

        // å¯ç”¨æœç´¢åŠŸèƒ½
        function enableSearch() {
            Elements.searchBtn.disabled = false;
            Elements.searchInput.disabled = false;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // æ›´æ–°æ ‡ç­¾å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}Tab`);
            });
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            Elements.statusIndicator.className = `status-indicator ${status}`;
            Elements.statusText.textContent = text;
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            updateStatus('error', 'å‘ç”Ÿé”™è¯¯');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.main-content'));
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.main-content'));
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>