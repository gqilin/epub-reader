<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUBReader é˜…è¯»å™¨æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .file-upload {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-upload:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .file-upload input {
            display: none;
        }

        /* å…ƒæ•°æ®åŒºåŸŸ */
        .metadata-section {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .book-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .book-meta {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        /* ç›®å½•åŒºåŸŸ */
        .toc-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .toc-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        /* æ ·å¼æ§åˆ¶é¢æ¿ */
        .style-controls {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .control-group {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.9rem;
        }

        .control-group .preset-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .preset-buttons button {
            flex: 1;
            padding: 5px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }

        .preset-buttons button:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .toolbar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #f0f0f0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chapter-info {
            font-size: 0.9rem;
            color: #666;
        }

        /* é˜…è¯»åŒºåŸŸ */
        .reading-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.1rem;
            color: #666;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            padding: 20px;
            background: #ffebee;
            color: #c62828;
            border-radius: 5px;
            margin: 20px;
            text-align: center;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .reading-area {
                padding: 20px;
            }
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h1>ğŸ“š EPUBé˜…è¯»å™¨</h1>
                <div class="file-upload">
                    <input type="file" id="epubFile" accept=".epub">
                    <label for="epubFile">ğŸ“ é€‰æ‹©EPUBæ–‡ä»¶</label>
                </div>
            </header>

            <!-- å…ƒæ•°æ® -->
            <section class="metadata-section" id="metadataArea">
                <div class="book-title">è¯·é€‰æ‹©EPUBæ–‡ä»¶</div>
                <div class="book-meta">æ”¯æŒEPUB 2.0/3.0æ ¼å¼</div>
            </section>

            <!-- ç›®å½• -->
            <section class="toc-section">
                <div class="toc-title">ğŸ“‘ ç›®å½•</div>
                <div id="tocArea">
                    <p style="color: #999; text-align: center;">æš‚æ— ç›®å½•</p>
                </div>
            </section>

            <!-- æ ·å¼æ§åˆ¶ -->
            <div class="style-controls" id="styleControls">
                <div class="control-group">
                    <label>ä¸»é¢˜</label>
                    <div class="preset-buttons">
                        <button onclick="applyTheme('light')">æµ…è‰²</button>
                        <button onclick="applyTheme('dark')">æ·±è‰²</button>
                        <button onclick="applyTheme('sepia')">æŠ¤çœ¼</button>
                        <button onclick="applyTheme('paper')">çº¸è´¨</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>å­—ä½“</label>
                    <select id="fontSelect" onchange="changeFont(this.value)">
                        <option value="system">ç³»ç»Ÿå­—ä½“</option>
                        <option value="serif">è¡¬çº¿å­—ä½“</option>
                        <option value="mono">ç­‰å®½å­—ä½“</option>
                        <option value="reading">é˜…è¯»å­—ä½“</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>å­—å·</label>
                    <select id="fontSizeSelect" onchange="changeFontSize(this.value)">
                        <option value="xs">æå°</option>
                        <option value="sm">å°</option>
                        <option value="md" selected>ä¸­</option>
                        <option value="lg">å¤§</option>
                        <option value="xl">æå¤§</option>
                        <option value="xxl">è¶…å¤§</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>è¡Œé«˜</label>
                    <select id="lineHeightSelect" onchange="changeLineHeight(this.value)">
                        <option value="compact">ç´§å‡‘</option>
                        <option value="normal">æ­£å¸¸</option>
                        <option value="comfortable" selected>èˆ’é€‚</option>
                        <option value="loose">å®½æ¾</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>æ–‡å­—é¢œè‰²</label>
                    <input type="color" id="fontColorInput" value="#333333" onchange="changeFontColor(this.value)">
                </div>

                <div class="control-group">
                    <label>èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="bgColorInput" value="#ffffff" onchange="changeBackgroundColor(this.value)">
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn" id="prevBtn" onclick="previousChapter()" disabled>â¬…ï¸ ä¸Šä¸€ç« </button>
                    <button class="btn" id="nextBtn" onclick="nextChapter()" disabled>ä¸‹ä¸€ç«  â¡ï¸</button>
                    <span class="chapter-info" id="chapterInfo">æœªåŠ è½½ç« èŠ‚</span>
                </div>
                <div class="toolbar-right">
                    <button class="btn" onclick="toggleFullscreen()">ğŸ”³ å…¨å±</button>
                    <button class="btn" onclick="toggleStylePanel()">ğŸ¨ æ ·å¼</button>
                </div>
            </div>

            <!-- é˜…è¯»åŒºåŸŸ -->
            <div class="reading-area" id="contentArea">
                <div class="loading">è¯·é€‰æ‹©EPUBæ–‡ä»¶å¼€å§‹é˜…è¯»</div>
            </div>
        </main>
    </div>

    <!-- å¼•å…¥åº“ -->
    <script src="./dist/epubreader.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let viewer = null;
        let styleController = null;
        let currentChapterIndex = 0;
        let totalChapters = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initViewer();
            setupEventListeners();
        });

        // åˆå§‹åŒ–é˜…è¯»å™¨
        function initViewer() {
            viewer = new EPUBReader.Viewer({
                container: document.querySelector('.reading-area'),
                contentArea: document.getElementById('contentArea'),
                tocArea: document.getElementById('tocArea'),
                metadataArea: document.getElementById('metadataArea'),
                settings: {
                    fontSize: '16px',
                    fontFamily: "'Microsoft YaHei', 'PingFang SC', sans-serif",
                    fontColor: '#333333',
                    backgroundColor: '#ffffff',
                    lineHeight: '1.8',
                    letterSpacing: '0px',
                    paragraphSpacing: '1em',
                    textAlign: 'left',
                    maxWidth: '900px',
                    padding: '0'
                },
                onChapterChange: function(chapter) {
                    updateChapterInfo(chapter);
                    updateNavigationButtons();
                },
                onLoad: function(book) {
                    updateChapterInfo(viewer.getCurrentChapter());
                    totalChapters = viewer.reader.getChapters().length;
                    updateNavigationButtons();
                    showSuccessMessage('EPUBåŠ è½½æˆåŠŸï¼');
                },
                onError: function(error) {
                    showErrorMessage('åŠ è½½å¤±è´¥: ' + error.message);
                }
            });

            // åˆå§‹åŒ–æ ·å¼æ§åˆ¶å™¨
            styleController = new EPUBReader.StyleController(viewer);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const fileInput = document.getElementById('epubFile');
            fileInput.addEventListener('change', handleFileSelect);
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.epub')) {
                showErrorMessage('è¯·é€‰æ‹©EPUBæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            try {
                showLoadingMessage('æ­£åœ¨åŠ è½½EPUBæ–‡ä»¶...');
                const arrayBuffer = await file.arrayBuffer();
                await viewer.load(arrayBuffer);
            } catch (error) {
                showErrorMessage('åŠ è½½EPUBæ–‡ä»¶å¤±è´¥: ' + error.message);
                console.error('åŠ è½½é”™è¯¯:', error);
            }
        }

        // ç« èŠ‚å¯¼èˆª
        async function previousChapter() {
            try {
                await viewer.previousChapter();
            } catch (error) {
                showErrorMessage('æ— æ³•è·³è½¬åˆ°ä¸Šä¸€ç« ');
            }
        }

        async function nextChapter() {
            try {
                await viewer.nextChapter();
            } catch (error) {
                showErrorMessage('æ— æ³•è·³è½¬åˆ°ä¸‹ä¸€ç« ');
            }
        }

        // æ ·å¼æ§åˆ¶å‡½æ•°
        function applyTheme(theme) {
            styleController.applyTheme(theme);
            updateColorInputs();
        }

        function changeFont(fontKey) {
            styleController.applyFont(fontKey);
        }

        function changeFontSize(sizeKey) {
            styleController.applyFontSize(sizeKey);
        }

        function changeLineHeight(heightKey) {
            styleController.applyLineHeight(heightKey);
        }

        function changeFontColor(color) {
            styleController.setFontColor(color);
        }

        function changeBackgroundColor(color) {
            styleController.setBackgroundColor(color);
        }

        // æ›´æ–°é¢œè‰²è¾“å…¥æ¡†
        function updateColorInputs() {
            const settings = viewer.getSettings();
            document.getElementById('fontColorInput').value = settings.fontColor;
            document.getElementById('bgColorInput').value = settings.backgroundColor;
        }

        // æ›´æ–°ç« èŠ‚ä¿¡æ¯
        function updateChapterInfo(chapter) {
            const chapterInfo = document.getElementById('chapterInfo');
            if (chapter) {
                const chapters = viewer.reader.getChapters();
                const currentIndex = chapters.findIndex(ch => ch.id === chapter.id);
                chapterInfo.textContent = `ç¬¬ ${currentIndex + 1} ç« : ${chapter.title}`;
                currentChapterIndex = currentIndex;
            } else {
                chapterInfo.textContent = 'æœªåŠ è½½ç« èŠ‚';
            }
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentChapterIndex <= 0;
            nextBtn.disabled = currentChapterIndex >= totalChapters - 1;
        }

        // åˆ‡æ¢æ ·å¼é¢æ¿
        function toggleStylePanel() {
            const styleControls = document.getElementById('styleControls');
            styleControls.classList.toggle('hidden');
        }

        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // æ¶ˆæ¯æç¤º
        function showLoadingMessage(message) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `<div class="loading">${message}</div>`;
        }

        function showSuccessMessage(message) {
            // ç®€å•çš„æˆåŠŸæç¤º
            console.log('âœ… ' + message);
        }

        function showErrorMessage(message) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `<div class="error">${message}</div>`;
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (!viewer || !viewer.getCurrentChapter()) return;

            switch(e.key) {
                case 'ArrowLeft':
                    if (!e.target.matches('input, select, textarea')) {
                        e.preventDefault();
                        previousChapter();
                    }
                    break;
                case 'ArrowRight':
                    if (!e.target.matches('input, select, textarea')) {
                        e.preventDefault();
                        nextChapter();
                    }
                    break;
                case 'f':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        toggleFullscreen();
                    }
                    break;
            }
        });
    </script>
</body>
</html>