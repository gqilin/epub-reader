<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVGæ ‡è®°åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .test-content {
            line-height: 1.6;
            font-size: 16px;
            color: #333;
            user-select: text;
            padding: 20px;
            background: #fafafa;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .toolbar {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: absolute;
            display: none;
            z-index: 1001;
        }
        
        .color-palette {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .color-btn {
            width: 28px;
            height: 28px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            border-color: #333;
        }
        
        .style-buttons {
            display: flex;
            gap: 6px;
        }
        
        .style-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }
        
        .style-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        
        .style-btn.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .create-btn {
            background: #4caf50;
            color: white;
        }
        
        .create-btn:hover {
            background: #45a049;
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
        }
        
        .delete-btn:hover {
            background: #da190b;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 14px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¨ SVGæ ‡è®°åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>æµ‹è¯•è¯´æ˜</h3>
            <p>1. é€‰æ‹©ä¸‹é¢çš„ä»»æ„æ–‡æœ¬ï¼Œå·¥å…·æ ä¼šè‡ªåŠ¨æ˜¾ç¤º</p>
            <p>2. é€‰æ‹©é¢œè‰²å’Œæ ·å¼ï¼Œç‚¹å‡»"åˆ›å»ºæ ‡è®°"</p>
            <p>3. ç‚¹å‡»å·²åˆ›å»ºçš„æ ‡è®°å¯ä»¥æŸ¥çœ‹ä¿¡æ¯</p>
            <p>4. ç‚¹å‡»"åˆ é™¤æ ‡è®°"å¯ä»¥åˆ é™¤é€‰ä¸­çš„æ ‡è®°</p>
        </div>
        
        <div id="test-content" class="test-section">
            <h3>æµ‹è¯•æ–‡æœ¬åŒºåŸŸ</h3>
            <div id="epub-viewer" class="test-content">
                <p>è¿™æ˜¯ä¸€æ®µç”¨äºæµ‹è¯•SVGæ ‡è®°åŠŸèƒ½çš„æ–‡æœ¬ã€‚æ‚¨å¯ä»¥<strong>é€‰æ‹©è¿™æ®µæ–‡å­—</strong>æ¥æµ‹è¯•é«˜äº®æ ‡è®°åŠŸèƒ½ã€‚</p>
                <p>è¿™é‡Œæœ‰<em>æ›´å¤šç¤ºä¾‹æ–‡æœ¬</em>ç”¨äºæµ‹è¯•ä¸åŒçš„æ ‡è®°æ ·å¼ã€‚æ‚¨å¯ä»¥é€‰æ‹©ä»»æ„é•¿åº¦çš„æ–‡æœ¬è¿›è¡Œæ ‡è®°ã€‚</p>
                <p>è¿™æ˜¯ç¬¬ä¸‰æ®µæ–‡æœ¬ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œ<u>æµ‹è¯•ä¸‹åˆ’çº¿æ ·å¼</u>ä»¥åŠå…¶ä»–æ ‡è®°æ•ˆæœã€‚</p>
                <p>SVGæ ‡è®°åŠŸèƒ½æ”¯æŒå¤šç§é¢œè‰²å’Œæ ·å¼ï¼ŒåŒ…æ‹¬å®çº¿ã€è™šçº¿ã€æ³¢æµªçº¿ç­‰è£…é¥°æ•ˆæœã€‚</p>
                <p>æœ€åä¸€æ®µæ–‡æœ¬ç”¨äºæµ‹è¯•æ ‡è®°çš„<strong>æŒä¹…åŒ–</strong>å’Œ<em>äº¤äº’åŠŸèƒ½</em>ã€‚</p>
            </div>
            
            <div class="status" id="status">
                å‡†å¤‡å°±ç»ªï¼è¯·é€‰æ‹©æ–‡æœ¬å¼€å§‹æµ‹è¯•æ ‡è®°åŠŸèƒ½ã€‚
            </div>
        </div>
        
        <!-- å·¥å…·æ  -->
        <div id="epub-marking-toolbar" class="toolbar">
            <div class="color-palette">
                <div class="color-btn" style="background-color: #ffeb3b" title="é»„è‰²" data-color="#ffeb3b"></div>
                <div class="color-btn" style="background-color: #4caf50" title="ç»¿è‰²" data-color="#4caf50"></div>
                <div class="color-btn" style="background-color: #2196f3" title="è“è‰²" data-color="#2196f3"></div>
                <div class="color-btn" style="background-color: #e91e63" title="ç²‰è‰²" data-color="#e91e63"></div>
                <div class="color-btn" style="background-color: #ff9800" title="æ©™è‰²" data-color="#ff9800"></div>
            </div>
            <div class="style-buttons">
                <button class="style-btn active" data-style="highlight">é«˜äº®</button>
                <button class="style-btn" data-style="underline">ä¸‹åˆ’çº¿</button>
                <button class="style-btn" data-style="dashed">è™šçº¿</button>
                <button class="style-btn" data-style="wavy">æ³¢æµªçº¿</button>
            </div>
            <button class="action-btn create-btn" id="create-btn">åˆ›å»ºæ ‡è®°</button>
            <button class="action-btn delete-btn" id="delete-btn">åˆ é™¤æ ‡è®°</button>
        </div>
    </div>

    <script type="module">
        // ç®€åŒ–ç‰ˆçš„SVGæ ‡è®°ç®¡ç†å™¨ï¼Œç”¨äºæµ‹è¯•
        class SimpleSVGMarkManager {
            constructor() {
                this.svgContainer = null;
                this.marks = new Map();
                this.currentSelection = null;
                this.toolbar = null;
                this.selectedColor = '#ffeb3b';
                this.selectedStyle = 'highlight';
                this.markCounter = 0;
                
                this.init();
            }
            
            init() {
                this.createSVGContainer();
                this.setupEventListeners();
            }
            
            createSVGContainer() {
                const viewer = document.getElementById('epub-viewer');
                if (!viewer) return;
                
                // è®¾ç½®viewerä¸ºç›¸å¯¹å®šä½
                viewer.style.position = 'relative';
                
                // åˆ›å»ºSVGå®¹å™¨
                this.svgContainer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                this.svgContainer.style.position = 'absolute';
                this.svgContainer.style.top = '0';
                this.svgContainer.style.left = '0';
                this.svgContainer.style.width = '100%';
                this.svgContainer.style.height = '100%';
                this.svgContainer.style.pointerEvents = 'none';
                this.svgContainer.style.zIndex = '1000';
                
                viewer.appendChild(this.svgContainer);
            }
            
            setupEventListeners() {
                // æ–‡æœ¬é€‰æ‹©äº‹ä»¶
                document.addEventListener('mouseup', (e) => {
                    setTimeout(() => this.handleSelection(e), 10);
                });
                
                document.addEventListener('selectionchange', () => {
                    const selection = window.getSelection();
                    if (!selection || selection.toString().trim().length === 0) {
                        this.hideToolbar();
                    }
                });
                
                // å·¥å…·æ äº‹ä»¶
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('color-btn')) {
                        this.selectColor(e.target.dataset.color);
                    } else if (e.target.classList.contains('style-btn')) {
                        this.selectStyle(e.target.dataset.style);
                    } else if (e.target.id === 'create-btn') {
                        this.createMark();
                    } else if (e.target.id === 'delete-btn') {
                        this.deleteMarkAtSelection();
                    } else if (!e.target.closest('#epub-marking-toolbar')) {
                        this.hideToolbar();
                    }
                });
            }
            
            handleSelection(event) {
                const selection = window.getSelection();
                if (!selection || selection.rangeCount === 0) return;
                
                const text = selection.toString().trim();
                if (text.length === 0) return;
                
                const range = selection.getRangeAt(0);
                this.currentSelection = { text, range };
                this.showToolbar(event.clientX, event.clientY);
            }
            
            showToolbar(x, y) {
                const toolbar = document.getElementById('epub-marking-toolbar');
                if (!toolbar) return;
                
                toolbar.style.left = `${x}px`;
                toolbar.style.top = `${y + 10}px`;
                toolbar.style.display = 'block';
                
                this.updateStatus(`å·²é€‰æ‹©æ–‡æœ¬: "${this.currentSelection.text.substring(0, 20)}..."`);
            }
            
            hideToolbar() {
                const toolbar = document.getElementById('epub-marking-toolbar');
                if (toolbar) {
                    toolbar.style.display = 'none';
                }
            }
            
            selectColor(color) {
                this.selectedColor = color;
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.color === color);
                });
                this.updateStatus(`é€‰æ‹©é¢œè‰²: ${color}`);
            }
            
            selectStyle(style) {
                this.selectedStyle = style;
                document.querySelectorAll('.style-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.style === style);
                });
                this.updateStatus(`é€‰æ‹©æ ·å¼: ${style}`);
            }
            
            createMark() {
                if (!this.currentSelection || !this.svgContainer) return;
                
                const markId = `mark-${++this.markCounter}`;
                const mark = {
                    id: markId,
                    text: this.currentSelection.text,
                    color: this.selectedColor,
                    style: this.selectedStyle,
                    created: new Date()
                };
                
                // åˆ›å»ºSVGå…ƒç´ 
                const svgElement = this.createSVGElement(mark);
                if (svgElement) {
                    this.svgContainer.appendChild(svgElement);
                    this.marks.set(markId, { ...mark, element: svgElement });
                    
                    // æ¸…é™¤é€‰æ‹©
                    window.getSelection()?.removeAllRanges();
                    this.currentSelection = null;
                    this.hideToolbar();
                    
                    this.updateStatus(`âœ… æˆåŠŸåˆ›å»ºæ ‡è®°: ${mark.text.substring(0, 20)}... (æ ·å¼: ${mark.style}, é¢œè‰²: ${mark.color})`);
                }
            }
            
            createSVGElement(mark) {
                const range = this.currentSelection.range;
                const rects = range.getClientRects();
                
                if (rects.length === 0) return null;
                
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('data-mark-id', mark.id);
                g.style.pointerEvents = 'auto';
                g.style.cursor = 'pointer';
                
                const viewerRect = this.svgContainer.getBoundingClientRect();
                
                for (let i = 0; i < rects.length; i++) {
                    const rect = rects[i];
                    const svgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    
                    svgRect.setAttribute('x', (rect.left - viewerRect.left).toString());
                    svgRect.setAttribute('y', (rect.top - viewerRect.top).toString());
                    svgRect.setAttribute('width', rect.width.toString());
                    svgRect.setAttribute('height', rect.height.toString());
                    
                    this.applyStyleToElement(svgRect, mark, rect, viewerRect);
                    g.appendChild(svgRect);
                }
                
                // ç‚¹å‡»äº‹ä»¶
                g.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.handleMarkClick(mark);
                });
                
                return g;
            }
            
            applyStyleToElement(element, mark, rect, viewerRect) {
                switch (mark.style) {
                    case 'highlight':
                        element.setAttribute('fill', mark.color);
                        element.setAttribute('fill-opacity', '0.7');
                        element.setAttribute('rx', '2');
                        break;
                    case 'underline':
                        element.setAttribute('fill', 'none');
                        element.setAttribute('stroke', mark.color);
                        element.setAttribute('stroke-width', '2');
                        element.setAttribute('height', '2');
                        element.setAttribute('y', (rect.bottom - viewerRect.top - 2).toString());
                        break;
                    case 'dashed':
                        element.setAttribute('fill', 'none');
                        element.setAttribute('stroke', mark.color);
                        element.setAttribute('stroke-width', '2');
                        element.setAttribute('stroke-dasharray', '5,5');
                        element.setAttribute('height', '2');
                        element.setAttribute('y', (rect.bottom - viewerRect.top - 2).toString());
                        break;
                    case 'wavy':
                        element.setAttribute('fill', 'none');
                        element.setAttribute('stroke', mark.color);
                        element.setAttribute('stroke-width', '2');
                        element.setAttribute('stroke-dasharray', '2,2');
                        element.setAttribute('height', '2');
                        element.setAttribute('y', (rect.bottom - viewerRect.top - 2).toString());
                        break;
                }
            }
            
            handleMarkClick(mark) {
                this.updateStatus(`ğŸ“Œ ç‚¹å‡»æ ‡è®°: "${mark.text}" (åˆ›å»ºæ—¶é—´: ${mark.created.toLocaleTimeString()})`);
            }
            
            deleteMarkAtSelection() {
                if (this.currentSelection) {
                    this.updateStatus('âš ï¸ è¯·å…ˆé€‰æ‹©è¦åˆ é™¤æ ‡è®°çš„æ–‡æœ¬åŒºåŸŸ');
                } else {
                    // ç®€åŒ–å®ç°ï¼šåˆ é™¤æœ€è¿‘çš„æ ‡è®°
                    if (this.marks.size > 0) {
                        const firstMarkId = this.marks.keys().next().value;
                        const markData = this.marks.get(firstMarkId);
                        if (markData && markData.element) {
                            this.svgContainer.removeChild(markData.element);
                            this.marks.delete(firstMarkId);
                            this.updateStatus(`ğŸ—‘ï¸ åˆ é™¤æ ‡è®°: ${markData.text.substring(0, 20)}...`);
                        }
                    } else {
                        this.updateStatus('ğŸ“­ æ²¡æœ‰å¯åˆ é™¤çš„æ ‡è®°');
                    }
                }
            }
            
            updateStatus(message) {
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                }
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleSVGMarkManager();
        });
    </script>
</body>
</html>