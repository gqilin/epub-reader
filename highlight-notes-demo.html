<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUBReader é«˜äº®ç¬”è®°æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .file-upload {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-upload:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .file-upload input {
            display: none;
        }

        /* æ ‡ç­¾é¡µåˆ‡æ¢ */
        .tab-container {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #e9ecef;
        }

        .tab-btn.active {
            background: white;
            border-bottom: 2px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }

        /* æ ‡ç­¾é¡µå†…å®¹ */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å…ƒæ•°æ®åŒºåŸŸ */
        .metadata-section {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .book-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .book-meta {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
        }

        /* ç›®å½•åŒºåŸŸ */
        .toc-section {
            padding: 15px;
        }

        .toc-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .toc-item {
            padding: 8px 0;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 0.9rem;
        }

        .toc-item:hover {
            background: #f0f0f0;
        }

        .toc-item.active {
            background: #e3f2fd;
            font-weight: bold;
            color: #1976d2;
        }

        .toc-level-1 { padding-left: 0; }
        .toc-level-2 { padding-left: 15px; font-size: 0.85rem; }
        .toc-level-3 { padding-left: 30px; font-size: 0.8rem; }

        /* ç¬”è®°åˆ—è¡¨ */
        .notes-section {
            padding: 15px;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .notes-title {
            font-weight: bold;
            color: #333;
        }

        .notes-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .clear-all-btn {
            padding: 5px 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .clear-all-btn:hover {
            background: #d32f2f;
        }

        .note-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .note-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .note-text {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #666;
        }

        .note-chapter {
            background: #e3f2fd;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .note-actions {
            display: flex;
            gap: 8px;
        }

        .note-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .note-action-btn:hover {
            opacity: 1;
        }

        .empty-notes {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-notes-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* æ ·å¼æ§åˆ¶é¢æ¿ */
        .style-controls {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            padding: 15px;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .preset-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .preset-buttons button {
            flex: 1;
            min-width: 60px;
            padding: 6px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .preset-buttons button:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .toolbar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #f0f0f0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .chapter-info {
            font-size: 0.9rem;
            color: #666;
        }

        /* é«˜äº®å·¥å…·æ  */
        .highlight-toolbar {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            gap: 5px;
        }

        .highlight-toolbar.show {
            display: flex;
        }

        .highlight-color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .highlight-color-btn:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .highlight-color-btn.yellow { background: #ffeb3b; }
        .highlight-color-btn.green { background: #76ff03; }
        .highlight-color-btn.blue { background: #40c4ff; }
        .highlight-color-btn.pink { background: #ff80ab; }
        .highlight-color-btn.purple { background: #e040fb; }

        .add-note-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .add-note-btn:hover {
            background: #5a6fd6;
        }

/* é˜…è¯»åŒºåŸŸ */
        .reading-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            position: relative;
        }

        .reading-area.paging-mode {
            overflow: hidden;
            padding: 0;
        }

        .reading-content {
            max-width: 800px;
            margin: 0 auto;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
        }

        /* ç¿»é¡µæ¨¡å¼æ ·å¼ */
        .paging-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .paging-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .horizontal-pages {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
            will-change: transform;
        }

        .page {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 0;
            overflow: hidden;
            box-sizing: border-box;
        }

        .page-content {
            background: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 8px;
            height: 100%;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            box-sizing: border-box;
        }

        /* å•æ æ¨¡å¼ */
        .single-column .page-content {
            max-width: 800px;
            width: 100%;
        }

        /* åŒæ æ¨¡å¼ */
        .double-column .page-content {
            max-width: 1200px;
            width: 100%;
            column-count: 2;
            column-gap: 40px;
            column-fill: auto;
        }

        .double-column .page-content h1,
        .double-column .page-content h2,
        .double-column .page-content h3 {
            column-span: all;
            break-after: avoid;
        }

        .double-column .page-content p {
            break-inside: avoid;
            margin-bottom: 1em;
        }

        /* é¡µé¢è¿‡æ¸¡åŠ¨ç”» */
        .horizontal-pages.page-transition {
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* ç¿»é¡µæ§åˆ¶æ ·å¼ */
        .paging-nav-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px;
            display: flex;
            pointer-events: none;
            z-index: 10;
        }

        .paging-nav-area {
            flex: 1;
            pointer-events: auto;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .paging-nav-area:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .paging-nav-area.prev {
            margin-right: 50%;
        }

        .paging-nav-area.next {
            margin-left: 50%;
        }

        /* ç¿»é¡µæ§åˆ¶ */
        .paging-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .paging-controls button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .paging-controls button:hover {
            background: #f0f0f0;
        }

        .paging-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 0.9rem;
            color: #666;
            min-width: 80px;
            text-align: center;
        }

        /* è§¦æ‘¸æ»‘åŠ¨æ‰‹åŠ¿æ”¯æŒ */
        .swipe-hint {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            color: rgba(0,0,0,0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .swipe-hint.left {
            left: 20px;
        }

        .swipe-hint.right {
            right: 20px;
        }

        .swipe-hint.show {
            opacity: 1;
        }

        /* æ¨¡å¼æŒ‰é’®æ ·å¼ */
        .mode-btn, .layout-btn {
            flex: 1;
            min-width: 60px;
            padding: 6px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .mode-btn:hover, .layout-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .mode-btn.active, .layout-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .reading-content p {
            margin-bottom: 1em;
        }

        /* é«˜äº®æ ·å¼ */
        .highlight-mark {
            border-radius: 2px;
            padding: 2px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .highlight-mark:hover {
            filter: brightness(0.9);
        }

        .highlight-mark.yellow { background: rgba(255, 235, 59, 0.5); }
        .highlight-mark.green { background: rgba(118, 255, 3, 0.5); }
        .highlight-mark.blue { background: rgba(64, 196, 255, 0.5); }
        .highlight-mark.pink { background: rgba(255, 128, 171, 0.5); }
        .highlight-mark.purple { background: rgba(224, 64, 251, 0.5); }

        .highlight-mark.has-note {
            border-bottom: 2px dashed #667eea;
        }

        /* ç¬”è®°å¼¹çª— */
        .note-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .note-modal.show {
            display: flex;
        }

        .note-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .note-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .note-modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .note-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .selected-text-preview {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-style: italic;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .note-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            resize: vertical;
            margin-bottom: 16px;
        }

        .note-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.1rem;
            color: #666;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            padding: 20px;
            background: #ffebee;
            color: #c62828;
            border-radius: 5px;
            margin: 20px;
            text-align: center;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.info { background: #2196f3; }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .reading-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h1>ğŸ“š EPUBé˜…è¯»å™¨</h1>
                <p>æ”¯æŒé«˜äº®ç¬”è®°åŠŸèƒ½</p>
                <div class="file-upload">
                    <input type="file" id="epubFile" accept=".epub">
                    <label for="epubFile">ğŸ“ é€‰æ‹©EPUBæ–‡ä»¶</label>
                </div>
            </header>

            <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tab-container">
                <button class="tab-btn active" data-tab="toc">ç›®å½•</button>
                <button class="tab-btn" data-tab="notes">
                    ç¬”è®° <span class="notes-count" id="notesCountBadge" style="display: none;">0</span>
                </button>
            </div>

            <!-- ç›®å½•æ ‡ç­¾é¡µ -->
            <div class="tab-content active" id="tocTab">
                <div class="metadata-section" id="metadataArea">
                    <div class="book-title">è¯·é€‰æ‹©EPUBæ–‡ä»¶</div>
                    <div class="book-meta">æ”¯æŒEPUB 2.0/3.0æ ¼å¼</div>
                </div>
                <div class="toc-section" id="tocArea">
                    <p style="color: #999; text-align: center;">æš‚æ— ç›®å½•</p>
                </div>
            </div>

            <!-- ç¬”è®°æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="notesTab">
                <div class="notes-section">
                    <div class="notes-header">
                        <span class="notes-title">ğŸ“ æˆ‘çš„ç¬”è®°</span>
                        <button class="clear-all-btn" onclick="clearAllNotes()" id="clearAllBtn" style="display: none;">æ¸…ç©ºå…¨éƒ¨</button>
                    </div>
                    <div id="notesList">
                        <div class="empty-notes">
                            <div class="empty-notes-icon">ğŸ“</div>
                            <p>è¿˜æ²¡æœ‰ç¬”è®°</p>
                            <p style="font-size: 0.85rem; margin-top: 5px;">é€‰ä¸­æ–‡æœ¬åæ·»åŠ é«˜äº®å’Œç¬”è®°</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ ·å¼æ§åˆ¶ -->
            <div class="style-controls">
                <div class="control-group">
                    <label>é˜…è¯»æ¨¡å¼</label>
                    <div class="preset-buttons">
                        <button onclick="setReadingMode('scroll')" id="scrollModeBtn" class="mode-btn active">æ»šåŠ¨</button>
                        <button onclick="setReadingMode('page')" id="pageModeBtn" class="mode-btn">ç¿»é¡µ</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>é¡µé¢å¸ƒå±€</label>
                    <div class="preset-buttons">
                        <button onclick="setColumnLayout('single')" id="singleColumnBtn" class="layout-btn active">å•æ </button>
                        <button onclick="setColumnLayout('double')" id="doubleColumnBtn" class="layout-btn">åŒæ </button>
                    </div>
                </div>
                <div class="control-group">
                    <label>ä¸»é¢˜</label>
                    <div class="preset-buttons">
                        <button onclick="applyTheme('light')">æµ…è‰²</button>
                        <button onclick="applyTheme('dark')">æ·±è‰²</button>
                        <button onclick="applyTheme('sepia')">æŠ¤çœ¼</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>å­—å·</label>
                    <select id="fontSizeSelect" onchange="changeFontSize(this.value)">
                        <option value="14px">å°</option>
                        <option value="16px" selected>ä¸­</option>
                        <option value="18px">å¤§</option>
                        <option value="20px">æå¤§</option>
                    </select>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn" id="prevBtn" onclick="previousChapter()" disabled>â¬…ï¸ ä¸Šä¸€ç« </button>
                    <button class="btn" id="nextBtn" onclick="nextChapter()" disabled>ä¸‹ä¸€ç«  â¡ï¸</button>
                    <span class="chapter-info" id="chapterInfo">æœªåŠ è½½ç« èŠ‚</span>
                </div>
                <div class="toolbar-right">
                    <button class="btn" onclick="exportNotes()">ğŸ“¤ å¯¼å‡ºç¬”è®°</button>
                    <button class="btn" onclick="importNotes()">ğŸ“¥ å¯¼å…¥ç¬”è®°</button>
                </div>
            </div>

            <!-- é˜…è¯»åŒºåŸŸ -->
            <div class="reading-area" id="readingArea">
                <div class="loading">è¯·é€‰æ‹©EPUBæ–‡ä»¶å¼€å§‹é˜…è¯»</div>
            </div>
        </main>
    </div>

    <!-- é«˜äº®å·¥å…·æ  -->
    <div class="highlight-toolbar" id="highlightToolbar">
        <button class="highlight-color-btn yellow" onclick="createHighlight('yellow')" title="é»„è‰²"></button>
        <button class="highlight-color-btn green" onclick="createHighlight('green')" title="ç»¿è‰²"></button>
        <button class="highlight-color-btn blue" onclick="createHighlight('blue')" title="è“è‰²"></button>
        <button class="highlight-color-btn pink" onclick="createHighlight('pink')" title="ç²‰è‰²"></button>
        <button class="highlight-color-btn purple" onclick="createHighlight('purple')" title="ç´«è‰²"></button>
        <button class="add-note-btn" onclick="showNoteModal()">ğŸ’¬ æ·»åŠ ç¬”è®°</button>
    </div>

    <!-- ç¬”è®°å¼¹çª— -->
    <div class="note-modal" id="noteModal">
        <div class="note-modal-content">
            <div class="note-modal-header">
                <span class="note-modal-title">ğŸ“ æ·»åŠ ç¬”è®°</span>
                <button class="note-modal-close" onclick="closeNoteModal()">&times;</button>
            </div>
            <div class="selected-text-preview" id="selectedTextPreview"></div>
            <textarea class="note-textarea" id="noteTextarea" placeholder="è¾“å…¥ç¬”è®°å†…å®¹..."></textarea>
            <div class="note-modal-actions">
                <button class="btn" onclick="closeNoteModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNote()">ä¿å­˜ç¬”è®°</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <!-- å¼•å…¥åº“ -->
    <script src="./dist/epubreader.js"></script>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let viewer = null;
        let currentBookId = null;
        let currentChapterId = null;
        let currentSelection = null;
        let currentRange = null;
        let highlights = []; // å½“å‰ä¹¦ç±çš„æ‰€æœ‰é«˜äº®
        
        // localStorage é”®åå‰ç¼€
        const STORAGE_KEY_PREFIX = 'epubreader_notes_';
        
        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            initViewer();
            setupEventListeners();
            setupTextSelection();
        });

        // åˆå§‹åŒ–é˜…è¯»å™¨
        function initViewer() {
            viewer = new EPUBReader.Viewer({
                container: document.querySelector('.reading-area'),
                contentArea: document.getElementById('readingArea'),
                tocArea: document.getElementById('tocArea'),
                metadataArea: document.getElementById('metadataArea'),
                settings: {
                    fontSize: '16px',
                    fontFamily: "'Microsoft YaHei', 'PingFang SC', sans-serif",
                    fontColor: '#333333',
                    backgroundColor: '#ffffff',
                    lineHeight: '1.8'
                },
                onChapterChange: function(chapter) {
                    currentChapterId = chapter.id;
                    updateChapterInfo(chapter);
                    updateNavigationButtons();
                    // ç« èŠ‚åˆ‡æ¢åæ¢å¤é«˜äº®
                    setTimeout(() => restoreHighlightsForCurrentChapter(), 100);
                },
                onLoad: function(book) {
                    currentBookId = generateBookId(book);
                    // åŠ è½½ä¿å­˜çš„ç¬”è®°
                    loadNotesFromStorage();
                    updateChapterInfo(viewer.getCurrentChapter());
                    updateNavigationButtons();
                    updateNotesList();
                    showToast('EPUBåŠ è½½æˆåŠŸï¼', 'success');
                },
                onError: function(error) {
                    showToast('åŠ è½½å¤±è´¥: ' + error.message, 'error');
                }
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶é€‰æ‹©
            document.getElementById('epubFile').addEventListener('change', handleFileSelect);
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—é«˜äº®å·¥å…·æ 
            document.addEventListener('click', (e) => {
                const toolbar = document.getElementById('highlightToolbar');
                if (!toolbar.contains(e.target)) {
                    hideHighlightToolbar();
                }
            });
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeNoteModal();
                    hideHighlightToolbar();
                }
                
                // ç¿»é¡µæ¨¡å¼çš„é”®ç›˜å¯¼èˆª
                if (viewer && viewer.settings.readingMode === 'page') {
                    if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
                        e.preventDefault();
                        viewer.previousPage();
                    } else if (e.key === 'ArrowRight' || e.key === 'PageDown' || e.key === ' ') {
                        e.preventDefault();
                        viewer.nextPage();
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        viewer.currentPage = 0;
                        viewer.updatePagePosition();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        viewer.currentPage = viewer.totalPages - 1;
                        viewer.updatePagePosition();
                    }
                }
                
                // æ»šåŠ¨æ¨¡å¼çš„é”®ç›˜å¯¼èˆª
                if (viewer && viewer.settings.readingMode === 'scroll') {
                    if (e.key === 'PageDown') {
                        e.preventDefault();
                        document.getElementById('readingArea').scrollBy({
                            top: window.innerHeight * 0.8,
                            behavior: 'smooth'
                        });
                    } else if (e.key === 'PageUp') {
                        e.preventDefault();
                        document.getElementById('readingArea').scrollBy({
                            top: -window.innerHeight * 0.8,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        }

        // è®¾ç½®æ–‡æœ¬é€‰æ‹©ç›‘å¬
        function setupTextSelection() {
            const readingArea = document.getElementById('readingArea');
            
            readingArea.addEventListener('mouseup', (e) => {
                setTimeout(() => {
                    const selection = window.getSelection();
                    if (selection.toString().trim().length > 0) {
                        const range = selection.getRangeAt(0);
                        currentSelection = selection.toString();
                        currentRange = range;
                        showHighlightToolbar(e.pageX, e.pageY);
                    } else {
                        hideHighlightToolbar();
                    }
                }, 10);
            });
            
            readingArea.addEventListener('keyup', (e) => {
                if (e.shiftKey) {
                    const selection = window.getSelection();
                    if (selection.toString().trim().length > 0) {
                        const range = selection.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        currentSelection = selection.toString();
                        currentRange = range;
                        showHighlightToolbar(rect.left + rect.width / 2, rect.top + window.scrollY);
                    }
                }
            });
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.epub')) {
                showToast('è¯·é€‰æ‹©EPUBæ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            try {
                showToast('æ­£åœ¨åŠ è½½EPUBæ–‡ä»¶...', 'info');
                const arrayBuffer = await file.arrayBuffer();
                await viewer.load(arrayBuffer);
            } catch (error) {
                showToast('åŠ è½½EPUBæ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                console.error('åŠ è½½é”™è¯¯:', error);
            }
        }

        // ==================== é«˜äº®åŠŸèƒ½ ====================
        function showHighlightToolbar(x, y) {
            const toolbar = document.getElementById('highlightToolbar');
            toolbar.style.left = Math.min(x - 100, window.innerWidth - 220) + 'px';
            toolbar.style.top = (y - 50) + 'px';
            toolbar.classList.add('show');
        }

        function hideHighlightToolbar() {
            document.getElementById('highlightToolbar').classList.remove('show');
        }

        function createHighlight(color) {
            if (!currentRange || !currentSelection) return;
            
            const highlightId = generateHighlightId();
            const highlightData = {
                id: highlightId,
                bookId: currentBookId,
                chapterId: currentChapterId,
                text: currentSelection,
                color: color,
                note: '',
                createdAt: new Date().toISOString(),
                xpath: getXPathForRange(currentRange)
            };
            
            // åœ¨DOMä¸­åˆ›å»ºé«˜äº®
            applyHighlightToDOM(currentRange, color, highlightId);
            
            // ä¿å­˜é«˜äº®æ•°æ®
            highlights.push(highlightData);
            saveNotesToStorage();
            
            // æ›´æ–°UI
            updateNotesList();
            showToast('é«˜äº®å·²æ·»åŠ ', 'success');
            
            // æ¸…é™¤é€‰æ‹©
            window.getSelection().removeAllRanges();
            hideHighlightToolbar();
            currentSelection = null;
            currentRange = null;
        }

        function applyHighlightToDOM(range, color, highlightId) {
            try {
                const span = document.createElement('span');
                span.className = `highlight-mark ${color}`;
                span.dataset.highlightId = highlightId;
                span.title = 'ç‚¹å‡»æŸ¥çœ‹ç¬”è®°';
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                span.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showHighlightDetails(highlightId);
                });
                
                range.surroundContents(span);
            } catch (e) {
                // å¦‚æœé€‰åŒºè·¨è¶Šå¤šä¸ªå…ƒç´ ï¼Œä½¿ç”¨å¦ä¸€ç§æ–¹æ³•
                const contents = range.extractContents();
                const span = document.createElement('span');
                span.className = `highlight-mark ${color}`;
                span.dataset.highlightId = highlightId;
                span.title = 'ç‚¹å‡»æŸ¥çœ‹ç¬”è®°';
                span.appendChild(contents);
                range.insertNode(span);
                
                span.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showHighlightDetails(highlightId);
                });
            }
        }

        function restoreHighlightsForCurrentChapter() {
            if (!currentChapterId || !currentBookId) return;
            
            const chapterHighlights = highlights.filter(h => h.chapterId === currentChapterId);
            
            chapterHighlights.forEach(highlight => {
                try {
                    // å°è¯•é€šè¿‡XPathæ‰¾åˆ°æ–‡æœ¬
                    const range = findRangeByXPath(highlight.xpath, highlight.text);
                    if (range) {
                        applyHighlightToDOM(range, highlight.color, highlight.id);
                        
                        // å¦‚æœæœ‰ç¬”è®°ï¼Œæ·»åŠ æ ‡è®°
                        if (highlight.note) {
                            const span = document.querySelector(`[data-highlight-id="${highlight.id}"]`);
                            if (span) {
                                span.classList.add('has-note');
                            }
                        }
                    }
                } catch (e) {
                    console.warn('æ— æ³•æ¢å¤é«˜äº®:', highlight.id, e);
                }
            });
        }

        // ==================== ç¬”è®°åŠŸèƒ½ ====================
        function showNoteModal() {
            if (!currentSelection) return;
            
            document.getElementById('selectedTextPreview').textContent = currentSelection;
            document.getElementById('noteTextarea').value = '';
            document.getElementById('noteModal').classList.add('show');
            document.getElementById('noteTextarea').focus();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('show');
        }

        function saveNote() {
            const noteText = document.getElementById('noteTextarea').value.trim();
            const color = 'yellow'; // é»˜è®¤é¢œè‰²
            
            if (!currentRange || !currentSelection) return;
            
            const highlightId = generateHighlightId();
            const highlightData = {
                id: highlightId,
                bookId: currentBookId,
                chapterId: currentChapterId,
                text: currentSelection,
                color: color,
                note: noteText,
                createdAt: new Date().toISOString(),
                xpath: getXPathForRange(currentRange)
            };
            
            // åœ¨DOMä¸­åˆ›å»ºé«˜äº®
            applyHighlightToDOM(currentRange, color, highlightId);
            
            // å¦‚æœæœ‰ç¬”è®°ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
            if (noteText) {
                const span = document.querySelector(`[data-highlight-id="${highlightId}"]`);
                if (span) {
                    span.classList.add('has-note');
                }
            }
            
            // ä¿å­˜é«˜äº®æ•°æ®
            highlights.push(highlightData);
            saveNotesToStorage();
            
            // æ›´æ–°UI
            updateNotesList();
            showToast(noteText ? 'ç¬”è®°å·²ä¿å­˜' : 'é«˜äº®å·²æ·»åŠ ', 'success');
            
            // æ¸…é™¤é€‰æ‹©
            window.getSelection().removeAllRanges();
            closeNoteModal();
            hideHighlightToolbar();
            currentSelection = null;
            currentRange = null;
        }

        function showHighlightDetails(highlightId) {
            const highlight = highlights.find(h => h.id === highlightId);
            if (!highlight) return;
            
            const noteText = highlight.note || '';
            const newNote = prompt('ç¼–è¾‘ç¬”è®°:', noteText);
            
            if (newNote !== null) {
                if (newNote === '' && !highlight.note) {
                    // åˆ é™¤é«˜äº®
                    removeHighlight(highlightId);
                } else {
                    // æ›´æ–°ç¬”è®°
                    highlight.note = newNote;
                    highlight.modifiedAt = new Date().toISOString();
                    
                    const span = document.querySelector(`[data-highlight-id="${highlightId}"]`);
                    if (span) {
                        if (newNote) {
                            span.classList.add('has-note');
                        } else {
                            span.classList.remove('has-note');
                        }
                    }
                    
                    saveNotesToStorage();
                    updateNotesList();
                    showToast('ç¬”è®°å·²æ›´æ–°', 'success');
                }
            }
        }

        function removeHighlight(highlightId) {
            const index = highlights.findIndex(h => h.id === highlightId);
            if (index > -1) {
                highlights.splice(index, 1);
                
                // ä»DOMä¸­ç§»é™¤
                const span = document.querySelector(`[data-highlight-id="${highlightId}"]`);
                if (span) {
                    const parent = span.parentNode;
                    while (span.firstChild) {
                        parent.insertBefore(span.firstChild, span);
                    }
                    parent.removeChild(span);
                    parent.normalize();
                }
                
                saveNotesToStorage();
                updateNotesList();
                showToast('é«˜äº®å·²åˆ é™¤', 'info');
            }
        }

        function clearAllNotes() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            // ä»DOMä¸­ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.highlight-mark').forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
                parent.normalize();
            });
            
            highlights = [];
            saveNotesToStorage();
            updateNotesList();
            showToast('æ‰€æœ‰ç¬”è®°å·²æ¸…ç©º', 'info');
        }

        // ==================== æœ¬åœ°å­˜å‚¨ ====================
        function saveNotesToStorage() {
            if (!currentBookId) return;
            
            const storageKey = STORAGE_KEY_PREFIX + currentBookId;
            const data = {
                bookId: currentBookId,
                highlights: highlights,
                savedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem(storageKey, JSON.stringify(data));
            } catch (e) {
                console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', e);
                showToast('ä¿å­˜ç¬”è®°å¤±è´¥ï¼Œå­˜å‚¨ç©ºé—´å¯èƒ½å·²æ»¡', 'error');
            }
        }

        function loadNotesFromStorage() {
            if (!currentBookId) return;
            
            const storageKey = STORAGE_KEY_PREFIX + currentBookId;
            const data = localStorage.getItem(storageKey);
            
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    highlights = parsed.highlights || [];
                    showToast(`å·²åŠ è½½ ${highlights.length} æ¡ç¬”è®°`, 'info');
                } catch (e) {
                    console.error('åŠ è½½ç¬”è®°å¤±è´¥:', e);
                    highlights = [];
                }
            } else {
                highlights = [];
            }
        }

        function exportNotes() {
            if (highlights.length === 0) {
                showToast('æ²¡æœ‰ç¬”è®°å¯å¯¼å‡º', 'error');
                return;
            }
            
            const data = {
                bookId: currentBookId,
                bookTitle: viewer?.reader?.getMetadata()?.title || 'Unknown',
                exportDate: new Date().toISOString(),
                highlights: highlights
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes_${currentBookId}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ç¬”è®°å·²å¯¼å‡º', 'success');
        }

        function importNotes() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.highlights && Array.isArray(data.highlights)) {
                            if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${data.highlights.length} æ¡ç¬”è®°å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰ä¹¦ç±çš„ç°æœ‰ç¬”è®°ã€‚`)) {
                                highlights = data.highlights;
                                saveNotesToStorage();
                                restoreHighlightsForCurrentChapter();
                                updateNotesList();
                                showToast('ç¬”è®°å¯¼å…¥æˆåŠŸ', 'success');
                            }
                        } else {
                            throw new Error('æ— æ•ˆçš„ç¬”è®°æ–‡ä»¶æ ¼å¼');
                        }
                    } catch (err) {
                        showToast('å¯¼å…¥å¤±è´¥: ' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== UIæ›´æ–° ====================
        function updateNotesList() {
            const notesList = document.getElementById('notesList');
            const notesCountBadge = document.getElementById('notesCountBadge');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            // æ›´æ–°å¾½ç« 
            if (highlights.length > 0) {
                notesCountBadge.textContent = highlights.length;
                notesCountBadge.style.display = 'inline';
                clearAllBtn.style.display = 'inline-block';
            } else {
                notesCountBadge.style.display = 'none';
                clearAllBtn.style.display = 'none';
            }
            
            // æ›´æ–°åˆ—è¡¨
            if (highlights.length === 0) {
                notesList.innerHTML = `
                    <div class="empty-notes">
                        <div class="empty-notes-icon">ğŸ“</div>
                        <p>è¿˜æ²¡æœ‰ç¬”è®°</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">é€‰ä¸­æ–‡æœ¬åæ·»åŠ é«˜äº®å’Œç¬”è®°</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedHighlights = [...highlights].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            notesList.innerHTML = sortedHighlights.map(h => `
                <div class="note-item" style="border-left-color: ${getColorCode(h.color)}; cursor: pointer;" onclick="jumpToHighlight('${h.id}')" title="ç‚¹å‡»è·³è½¬åˆ°è¯¥ä½ç½®">
                    <div class="note-text">${escapeHtml(h.text)}</div>
                    ${h.note ? `<div style="font-size: 0.85rem; color: #667eea; margin-bottom: 8px; font-style: italic;">ğŸ’¬ ${escapeHtml(h.note)}</div>` : ''}
                    <div class="note-meta">
                        <span class="note-chapter">${escapeHtml(getChapterTitle(h.chapterId))}</span>
                        <div class="note-actions" onclick="event.stopPropagation()">
                            <button class="note-action-btn" onclick="jumpToHighlight('${h.id}')" title="è·³è½¬">ğŸ“</button>
                            <button class="note-action-btn" onclick="deleteHighlight('${h.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });
        }

        function updateChapterInfo(chapter) {
            if (chapter) {
                document.getElementById('chapterInfo').textContent = 
                    `${chapter.title || 'æœªå‘½åç« èŠ‚'}`;
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (!viewer || !viewer.reader) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            const chapters = viewer.reader.getChapters();
            const currentChapter = viewer.getCurrentChapter();
            
            if (!currentChapter) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            const currentIndex = chapters.findIndex(ch => ch.id === currentChapter.id);
            
            prevBtn.disabled = currentIndex <= 0;
            nextBtn.disabled = currentIndex >= chapters.length - 1;
        }

        // ==================== ç« èŠ‚å¯¼èˆª ====================
        async function previousChapter() {
            try {
                await viewer.previousChapter();
            } catch (error) {
                showToast('æ— æ³•è·³è½¬åˆ°ä¸Šä¸€ç« ', 'error');
            }
        }

        async function nextChapter() {
            try {
                await viewer.nextChapter();
            } catch (error) {
                showToast('æ— æ³•è·³è½¬åˆ°ä¸‹ä¸€ç« ', 'error');
            }
        }

        async function jumpToHighlight(highlightId) {
            const highlight = highlights.find(h => h.id === highlightId);
            if (!highlight) return;
            
            // å¦‚æœä¸åœ¨å½“å‰ç« èŠ‚ï¼Œå…ˆè·³è½¬
            if (highlight.chapterId !== currentChapterId) {
                try {
                    await viewer.loadChapter(highlight.chapterId);
                } catch (e) {
                    showToast('æ— æ³•è·³è½¬åˆ°è¯¥ç« èŠ‚', 'error');
                    return;
                }
            }
            
            // é«˜äº®å¯¹åº”å…ƒç´ 
            setTimeout(() => {
                const element = document.querySelector(`[data-highlight-id="${highlightId}"]`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.style.animation = 'pulse 1s ease';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 1000);
                    
                    // åˆ‡æ¢åˆ°ç›®å½•æ ‡ç­¾
                    switchTab('toc');
                }
            }, 200);
        }

        function deleteHighlight(highlightId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
                removeHighlight(highlightId);
            }
        }

        // ==================== é˜…è¯»æ¨¡å¼æ§åˆ¶ ====================
        function setReadingMode(mode) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'scroll') {
                document.getElementById('scrollModeBtn').classList.add('active');
            } else {
                document.getElementById('pageModeBtn').classList.add('active');
            }
            
            // æ›´æ–°é˜…è¯»å™¨è®¾ç½®
            if (viewer) {
                viewer.setReadingMode(mode);
                showToast(`å·²åˆ‡æ¢åˆ°${mode === 'scroll' ? 'æ»šåŠ¨' : 'ç¿»é¡µ'}æ¨¡å¼`, 'info');
            }
        }

        function setColumnLayout(layout) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (layout === 'single') {
                document.getElementById('singleColumnBtn').classList.add('active');
            } else {
                document.getElementById('doubleColumnBtn').classList.add('active');
            }
            
            // æ›´æ–°é˜…è¯»å™¨è®¾ç½®
            if (viewer) {
                viewer.setColumnLayout(layout);
                showToast(`å·²åˆ‡æ¢åˆ°${layout === 'single' ? 'å•æ ' : 'åŒæ '}å¸ƒå±€`, 'info');
            }
        }

        // ==================== æ ·å¼æ§åˆ¶ ====================
        function applyTheme(theme) {
            const themes = {
                light: { bg: '#ffffff', color: '#333333' },
                dark: { bg: '#1e1e1e', color: '#e0e0e0' },
                sepia: { bg: '#f4f1e8', color: '#5c4b37' }
            };
            
            const t = themes[theme];
            if (t) {
                document.querySelector('.reading-content')?.style.setProperty('background-color', t.bg);
                document.querySelector('.reading-content')?.style.setProperty('color', t.color);
                document.getElementById('readingArea').style.backgroundColor = t.bg;
                
                // æ›´æ–°ç¿»é¡µæ¨¡å¼çš„èƒŒæ™¯
                document.querySelectorAll('.page-content').forEach(page => {
                    page.style.backgroundColor = t.bg;
                    page.style.color = t.color;
                });
            }
            
            // åŒæ—¶æ›´æ–°é˜…è¯»å™¨è®¾ç½®
            if (viewer) {
                viewer.setBackgroundColor(t.bg);
                viewer.setFontColor(t.color);
            }
        }

        function changeFontSize(size) {
            document.querySelector('.reading-content')?.style.setProperty('font-size', size);
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.fontSize = size;
            });
            
            // æ›´æ–°é˜…è¯»å™¨è®¾ç½®å¹¶é‡æ–°åˆ†é¡µ
            if (viewer) {
                viewer.setFontSize(size);
                if (viewer.settings.readingMode === 'page' && viewer.currentChapter) {
                    // ç¿»é¡µæ¨¡å¼ä¸‹é‡æ–°åˆ†é¡µ
                    setTimeout(() => {
                        viewer.renderChapter(viewer.currentChapter);
                    }, 100);
                }
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function generateBookId(book) {
            // åŸºäºä¹¦ç±å…ƒæ•°æ®ç”Ÿæˆå”¯ä¸€ID
            const metadata = viewer?.reader?.getMetadata();
            if (metadata) {
                const str = `${metadata.title}_${metadata.creator}_${metadata.identifier}`;
                return hashString(str);
            }
            return 'unknown_' + Date.now();
        }

        function generateHighlightId() {
            return 'hl_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        function getColorCode(colorName) {
            const colors = {
                yellow: '#ffeb3b',
                green: '#76ff03',
                blue: '#40c4ff',
                pink: '#ff80ab',
                purple: '#e040fb'
            };
            return colors[colorName] || '#ffeb3b';
        }

        function getChapterTitle(chapterId) {
            if (!viewer || !viewer.reader) return 'æœªçŸ¥ç« èŠ‚';
            const chapters = viewer.reader.getChapters();
            const chapter = chapters.find(ch => ch.id === chapterId);
            return chapter?.title || 'æœªçŸ¥ç« èŠ‚';
        }

        function getXPathForRange(range) {
            // ç®€åŒ–çš„XPathè·å–
            const container = range.commonAncestorContainer;
            if (container.nodeType === Node.TEXT_NODE) {
                return getXPath(container.parentNode);
            }
            return getXPath(container);
        }

        function getXPath(element) {
            if (element.id) {
                return `//*[@id="${element.id}"]`;
            }
            
            const path = [];
            while (element && element.nodeType === Node.ELEMENT_NODE) {
                let index = 1;
                let sibling = element.previousSibling;
                while (sibling) {
                    if (sibling.nodeType === Node.ELEMENT_NODE && sibling.tagName === element.tagName) {
                        index++;
                    }
                    sibling = sibling.previousSibling;
                }
                path.unshift(`${element.tagName.toLowerCase()}[${index}]`);
                element = element.parentNode;
            }
            return '/' + path.join('/');
        }

        function findRangeByXPath(xpath, searchText) {
            try {
                const result = document.evaluate(
                    xpath, 
                    document, 
                    null, 
                    XPathResult.FIRST_ORDERED_NODE_TYPE, 
                    null
                );
                const element = result.singleNodeValue;
                
                if (element) {
                    // åœ¨å…ƒç´ ä¸­æŸ¥æ‰¾æ–‡æœ¬
                    const walker = document.createTreeWalker(
                        element,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );
                    
                    let node;
                    while (node = walker.nextNode()) {
                        const index = node.textContent.indexOf(searchText);
                        if (index !== -1) {
                            const range = document.createRange();
                            range.setStart(node, index);
                            range.setEnd(node, index + searchText.length);
                            return range;
                        }
                    }
                }
            } catch (e) {
                console.warn('XPathæŸ¥æ‰¾å¤±è´¥:', e);
            }
            return null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { background-color: inherit; }
                50% { background-color: rgba(102, 126, 234, 0.3); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
